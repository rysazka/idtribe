<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelas Digital Intermediate - ID-TRIBE</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --forest-green: #2E5C48;
            --golden-orange: #F2994A;
            --purple-intermediate: #a855f7; /* Aksen Khusus Intermediate */
            --text-dark: #1a1a1a;
            --text-muted: #64748b;
            
            /* Glass Effect */
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-blur: blur(20px);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }

        body { font-family: 'Lato', sans-serif; background: var(--forest-green); color: var(--text-dark); margin: 0; padding-bottom: 50px; }
        
        .bg-image {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1619338098121-5925681fc9ab?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=1920');
            background-size: cover; background-position: center; z-index: -2;
        }
        .bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(46, 92, 72, 0.95), rgba(46, 92, 72, 0.8)); z-index: -1;
        }

        .nav-top { padding: 20px 20px 0; max-width: 1100px; margin: 0 auto; position: relative; z-index: 10; }
        .nav-top a { color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .nav-top a:hover { color: white; }

        .container { max-width: 1100px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 2fr 1fr; gap: 30px; position: relative; z-index: 10; }

        /* Video Section */
        .video-section { position: sticky; top: 20px; height: fit-content; }
        .video-box {
            width: 100%; aspect-ratio: 16/9; background: black; border-radius: 16px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border: 4px solid rgba(255,255,255,0.1); overflow: hidden; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        .progress-bar-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 6px; background: rgba(255,255,255,0.2); }
        .progress-bar-fill { height: 100%; background: var(--purple-intermediate); width: 0%; transition: width 0.2s linear; }

        .info-card {
            background: var(--glass-bg); padding: 25px; border-radius: 16px; border: 1px solid var(--glass-border); 
            margin-top: 20px; box-shadow: var(--glass-shadow); backdrop-filter: var(--glass-blur);
        }

        /* Syllabus */
        .syllabus-card { background: white; border-radius: 16px; padding: 20px; box-shadow: var(--glass-shadow); }
        .syllabus-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid #f1f5f9; color: var(--text-muted); font-size: 0.9rem; }
        .syllabus-item.active { background: #faf5ff; border-radius: 8px; border-bottom: none; color: var(--purple-intermediate); font-weight: 600; }
        .icon-type { width: 24px; text-align: center; font-size: 1.1rem; }

        /* Buttons */
        .btn { padding: 12px 25px; border-radius: 10px; cursor: pointer; border: none; font-weight: 700; width: 100%; margin-top: 15px; transition: all 0.3s; font-size: 0.95rem; }
        .btn-primary { background: var(--purple-intermediate); color: white; }
        .btn-primary:hover { background: #9333ea; }
        .btn-success { background: #10b981; color: white; }
        .btn-disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }
        .btn-cert { background: linear-gradient(135deg, #a855f7, #7c3aed); color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* Quiz Modal */
        .quiz-modal {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0, 0, 0, 0.8); z-index: 100;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .quiz-card {
            background: white; padding: 40px; border-radius: 20px; max-width: 700px; width: 90%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;
        }

        .question-item { margin-bottom: 25px; border-bottom: 1px solid #f1f5f9; padding-bottom: 20px; }
        .question-text { font-weight: 700; margin-bottom: 15px; font-size: 1rem; color: var(--text-dark); }
        
        .option-label {
            display: flex; align-items: center; gap: 10px;
            padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; 
            margin-bottom: 8px; cursor: pointer; transition: all 0.2s; background: white;
        }
        .option-label:hover { border-color: var(--purple-intermediate); background: #faf5ff; }
        .option-label input:checked + span { color: var(--purple-intermediate); font-weight: bold; }
        .option-label:has(input:checked) { border-color: var(--purple-intermediate); background: #f3e8ff; }

        .result-screen { text-align: center; display: none; }
        .emoji-result { font-size: 4rem; margin-bottom: 10px; display: block; }

        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .video-section { position: relative; top: 0; }
        }
    </style>
</head>
<body>

    <div class="bg-image"></div>
    <div class="bg-overlay"></div>

    <div class="nav-top">
        <a href="training-hub.html">&larr; Kembali ke Library</a>
    </div>

    <div class="container">
        
        <div class="video-section">
            <div class="video-box" id="videoScreen">
                <div style="text-align: center; z-index: 2; padding: 20px;">
                    <h2 style="margin-bottom: 5px; color: white;">üé• Webinar: Content Strategy</h2>
                    <p style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 20px;">Strategi Konten & Penjadwalan (Meta Suite)</p>
                    <button class="btn btn-primary" style="width: auto; padding: 10px 30px;" onclick="playVideo()">Putar Video</button>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="videoProgress"></div>
                </div>
            </div>

            <div class="info-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: var(--text-muted); font-size: 0.9rem;">Status Belajar</span>
                    <strong id="statusLabel" style="color: var(--purple-intermediate);">Sedang Berlangsung...</strong>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px; line-height: 1.5;">
                    üí° <strong>Aturan 90%:</strong> Tonton materi tentang Canva, CapCut, & Meta Suite hingga 90% durasi untuk membuka ujian.
                </p>
                <button id="btnQuiz" class="btn btn-disabled" disabled onclick="openQuiz()">
                    üîí Ambil Kuis Intermediate
                </button>
            </div>
        </div>

        <div>
            <div class="syllabus-card">
                <h3 style="margin-bottom: 20px; color: var(--text-dark); font-size: 1.1rem;">üìö Materi Digital Intermediate</h3>
                
                <div class="syllabus-item active">
                    <span class="icon-type">üé•</span>
                    <div>
                        <div style="font-weight: 600;">Strategi Konten & Scheduling</div>
                        <div style="font-size: 0.75rem; color: var(--purple-intermediate);">Sedang Diputar</div>
                    </div>
                </div>
                <div class="syllabus-item"><span class="icon-type">üìò</span><div><div style="font-weight: 600;">Playbook: Kalender Konten</div><a href="#" style="font-size: 0.75rem; color: var(--purple-intermediate);">Download Template Excel</a></div></div>
                <div class="syllabus-item"><span class="icon-type">üë•</span><div><div style="font-weight: 600;">Forum Diskusi</div><a href="#" style="font-size: 0.75rem; color: var(--purple-intermediate);">Diskusi Reach & Ads</a></div></div>
                <div class="syllabus-item"><span class="icon-type">üí°</span><div><div style="font-weight: 600;">Case Study</div><div style="font-size: 0.75rem;">Naik Omzet via CapCut</div></div></div>
            </div>
        </div>

    </div>

    <div class="quiz-modal" id="quizModal">
        <div class="quiz-card">
            
            <div id="quizContent">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="color: var(--purple-intermediate);">üìù Ujian Digital Intermediate</h3>
                    <span style="color: var(--text-muted); font-size: 0.9rem; background: #f1f5f9; padding: 5px 10px; border-radius: 8px;">Min. Skor: 70</span>
                </div>
                <div style="height: 1px; background: #e2e8f0; margin: 15px 0 25px;"></div>

                <div class="question-item">
                    <p class="question-text">1. Dalam Canva, mengapa penggunaan 'Template' disarankan untuk UMKM?</p>
                    <label class="option-label"><input type="radio" name="q1" value="wrong"><span>Agar terlihat sama dengan kompetitor</span></label>
                    <label class="option-label"><input type="radio" name="q1" value="correct"><span>Menjaga konsistensi visual branding & hemat waktu</span></label>
                    <label class="option-label"><input type="radio" name="q1" value="wrong"><span>Karena template selalu gratis</span></label>
                </div>

                <div class="question-item">
                    <p class="question-text">2. Di CapCut, apa elemen terpenting di 3 detik pertama (The Hook)?</p>
                    <label class="option-label"><input type="radio" name="q2" value="correct"><span>Visual/kalimat yang mengejutkan atau bikin penasaran</span></label>
                    <label class="option-label"><input type="radio" name="q2" value="wrong"><span>Logo perusahaan durasi panjang</span></label>
                    <label class="option-label"><input type="radio" name="q2" value="wrong"><span>Layar hitam kosong (Fade in)</span></label>
                </div>

                <div class="question-item">
                    <p class="question-text">3. Apa fungsi utama fitur 'Planner' di Meta Business Suite?</p>
                    <label class="option-label"><input type="radio" name="q3" value="wrong"><span>Membeli follower otomatis</span></label>
                    <label class="option-label"><input type="radio" name="q3" value="wrong"><span>Mengedit foto menjadi video</span></label>
                    <label class="option-label"><input type="radio" name="q3" value="correct"><span>Menjadwalkan postingan IG & FB otomatis</span></label>
                </div>

                <div class="question-item">
                    <p class="question-text">4. Dalam analisis performa, metrik 'Reach' (Jangkauan) berarti?</p>
                    <label class="option-label"><input type="radio" name="q4" value="correct"><span>Jumlah akun unik yang melihat konten</span></label>
                    <label class="option-label"><input type="radio" name="q4" value="wrong"><span>Jumlah like dan komentar</span></label>
                    <label class="option-label"><input type="radio" name="q4" value="wrong"><span>Total tayangan (termasuk pengulangan)</span></label>
                </div>

                <div class="question-item">
                    <p class="question-text">5. Teknik 'Storytelling' dalam caption bertujuan untuk?</p>
                    <label class="option-label"><input type="radio" name="q5" value="wrong"><span>Membuat caption sangat panjang</span></label>
                    <label class="option-label"><input type="radio" name="q5" value="wrong"><span>Menipu algoritma Instagram</span></label>
                    <label class="option-label"><input type="radio" name="q5" value="correct"><span>Membangun koneksi emosional (Soft Selling)</span></label>
                </div>

                <div style="display:flex; gap:10px; margin-top:30px;">
                    <button class="btn btn-disabled" style="background:transparent; border:1px solid #cbd5e1; color:#64748b;" onclick="closeQuiz()">Batal</button>
                    <button class="btn btn-primary" onclick="submitQuiz()">Kirim Jawaban</button>
                </div>
            </div>

            <div id="resultSuccess" class="result-screen">
                <span class="emoji-result">üöÄ</span>
                <h2 style="color: var(--purple-intermediate);">LULUS! (Skor: <span id="scoreValSuccess"></span>)</h2>
                <p style="color: var(--text-muted);">Luar biasa! Kemampuan konten kreasi Anda telah teruji.</p>
                
                <button class="btn btn-cert" onclick="generateCertificate()">
                    üìú Download Sertifikat Intermediate
                </button>

                <div style="height: 1px; background: #e2e8f0; margin: 20px 0;"></div>
                
                <p style="font-size: 0.9rem; color: var(--text-muted);">Level Digital Anda telah naik. Bersiap ke level Advanced?</p>
                <button class="btn btn-success" onclick="finishCourse()">Kembali ke Training Hub &rarr;</button>
            </div>

            <div id="resultFail" class="result-screen">
                <span class="emoji-result">üìâ</span>
                <h2 style="color: var(--golden-orange);">Belum Lulus</h2>
                <p style="color: var(--text-muted);">Skor Anda: <span id="scoreValFail"></span>/100</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">Pelajari kembali materi Canva & CapCut.<br>Minimal skor 70.</p>
                <button class="btn btn-primary" onclick="retryCourse()">üîÑ Ulangi Materi</button>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIaLzkNM0KqPVKxuMNmardLqcrr2kYTWQ",
            authDomain: "database-idbm.firebaseapp.com",
            projectId: "database-idbm",
            storageBucket: "database-idbm.firebasestorage.app",
            messagingSenderId: "1052290789133",
            appId: "1:1052290789133:web:36b513630b7a87154eca44",
            measurementId: "G-EQLBB94DY2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserName = "Peserta UMKM";

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docSnap = await getDoc(doc(db, "users_umkm", user.uid));
                if (docSnap.exists()) {
                    currentUserName = docSnap.data().nama_lengkap;
                }
            }
        });

        // --- VIDEO SIMULATION ---
        let videoDuration = 5; 
        let currentTime = 0;
        let videoInterval;

        window.playVideo = function() {
            const screen = document.getElementById('videoScreen');
            const btn = screen.querySelector('button');
            const title = screen.querySelector('h2');
            
            btn.style.display = 'none';
            title.innerText = "‚ñ∂ Sedang Memutar...";
            title.style.color = "var(--purple-intermediate)";

            videoInterval = setInterval(() => {
                currentTime++;
                const percentage = (currentTime / videoDuration) * 100;
                document.getElementById('videoProgress').style.width = `${percentage}%`;

                if (percentage >= 90) unlockQuizButton();

                if (currentTime >= videoDuration) {
                    clearInterval(videoInterval);
                    title.innerText = "‚úÖ Materi Selesai";
                    title.style.color = "#10b981"; 
                }
            }, 1000);
        }

        function unlockQuizButton() {
            const btnQuiz = document.getElementById('btnQuiz');
            const label = document.getElementById('statusLabel');
            
            if (btnQuiz.disabled) {
                btnQuiz.disabled = false;
                btnQuiz.classList.remove('btn-disabled');
                btnQuiz.classList.add('btn-primary');
                btnQuiz.innerHTML = "üìù Ambil Kuis Intermediate";
                label.innerText = "Siap Validasi";
                label.style.color = "#10b981";
            }
        }

        // --- QUIZ LOGIC ---
        window.openQuiz = () => document.getElementById('quizModal').style.display = 'flex';
        window.closeQuiz = () => document.getElementById('quizModal').style.display = 'none';

        window.submitQuiz = function() {
            for(let i=1; i<=5; i++) {
                if(!document.querySelector(`input[name="q${i}"]:checked`)) {
                    alert(`Pertanyaan nomor ${i} belum dijawab!`);
                    return;
                }
            }

            let score = 0;
            const answers = [
                document.querySelector('input[name="q1"]:checked').value,
                document.querySelector('input[name="q2"]:checked').value,
                document.querySelector('input[name="q3"]:checked').value,
                document.querySelector('input[name="q4"]:checked').value,
                document.querySelector('input[name="q5"]:checked').value
            ];

            answers.forEach(ans => { if(ans === 'correct') score += 20; });

            document.getElementById('quizContent').style.display = 'none';

            if (score >= 70) {
                document.getElementById('resultSuccess').style.display = 'block';
                document.getElementById('scoreValSuccess').innerText = score;
                saveProgressToFirebase(true);
            } else {
                document.getElementById('resultFail').style.display = 'block';
                document.getElementById('scoreValFail').innerText = score;
            }
        }

        window.retryCourse = function() {
            document.getElementById('quizModal').style.display = 'none';
            document.getElementById('quizContent').style.display = 'block';
            document.getElementById('resultFail').style.display = 'none';
            document.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
        }

        window.finishCourse = function() {
            window.location.href = "training-hub.html";
        }

        // --- GENERATE CERTIFICATE ---
        window.generateCertificate = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });

            doc.setDrawColor(168, 85, 247); // Purple
            doc.setLineWidth(3);
            doc.rect(10, 10, 277, 190);

            doc.setFont("helvetica", "bold");
            doc.setFontSize(24);
            doc.setTextColor(15, 23, 42);
            doc.text("SERTIFIKAT KOMPETENSI", 148.5, 40, null, null, "center");

            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text("ID-TRIBE Training Hub", 148.5, 50, null, null, "center");

            doc.setFont("helvetica", "normal");
            doc.setFontSize(16);
            doc.setTextColor(0);
            doc.text("Diberikan kepada:", 148.5, 80, null, null, "center");

            doc.setFont("times", "bolditalic");
            doc.setFontSize(36);
            doc.setTextColor(168, 85, 247); // Purple Name
            doc.text(currentUserName, 148.5, 100, null, null, "center");

            doc.setFont("helvetica", "normal");
            doc.setFontSize(14);
            doc.setTextColor(0);
            doc.text("Telah lulus ujian validasi materi tingkat Lanjut:", 148.5, 125, null, null, "center");

            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.text("DIGITAL & MARKETING EMPOWERMENT (INTERMEDIATE)", 148.5, 140, null, null, "center");

            const date = new Date().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Jakarta, ${date}`, 148.5, 165, null, null, "center");

            doc.save(`Sertifikat_Intermediate_${currentUserName}.pdf`);
        }

        // --- DATABASE UPDATE ---
        async function saveProgressToFirebase(isPassed) {
            const user = auth.currentUser;
            if (user && isPassed) {
                try {
                    await updateDoc(doc(db, "users_umkm", user.uid), {
                        completed_courses: arrayUnion("digital_intermediate"),
                        
                        // Update Level Text & Score di Dashboard
                        "health_check_result.Digital & Marketing.level": "Intermediate",
                        "health_check_result.Digital & Marketing.score": 10 // Naik skor
                    });
                    console.log("Database Updated");
                } catch (e) {
                    console.error("Error saving:", e);
                }
            }
        }
    </script>
</body>
</html>