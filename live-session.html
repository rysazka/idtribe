<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Room - ID-TRIBE</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

    <style>
        /* CSS TETAP SAMA */
        :root { --primary: #2E5C48; --accent: #F2994A; --dark: #1a1a1a; --bg: #f0fdf4; --chat-bg: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Lato', sans-serif; background: var(--dark); color: white; height: 100vh; overflow: hidden; }
        .live-container { display: grid; grid-template-columns: 1fr 350px; height: 100vh; }
        .stage-area { position: relative; display: flex; flex-direction: column; background: black; justify-content: center; align-items: center; }
        .video-wrapper { width: 100%; height: 100%; position: relative; overflow: hidden; }
        iframe, video.custom-video-player { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; border: none; }
        .overlay-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent 20%, transparent 80%, rgba(0,0,0,0.8)); }
        .top-bar { display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }
        .back-btn { background: rgba(255,255,255,0.2); color: white; padding: 8px 15px; border-radius: 50px; text-decoration: none; backdrop-filter: blur(5px); display: flex; align-items: center; gap: 8px; font-weight: 700; transition: 0.2s; }
        .back-btn:hover { background: rgba(255,255,255,0.4); }
        .live-badge { background: #ef4444; color: white; padding: 5px 12px; border-radius: 4px; font-weight: 800; font-size: 0.9rem; text-transform: uppercase; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .viewer-count { background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 4px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; margin-top: 5px; }
        .bottom-bar { display: flex; align-items: flex-end; justify-content: space-between; pointer-events: auto; }
        .mentor-profile { display: flex; align-items: center; gap: 12px; }
        .mentor-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--accent); }
        .floating-actions { display: flex; gap: 10px; flex-direction: column; align-items: center; }
        .action-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: rgba(255,255,255,0.15); color: white; backdrop-filter: blur(5px); cursor: pointer; font-size: 1.2rem; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .action-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .btn-love { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .hearts-container { position: absolute; bottom: 80px; right: 30px; width: 50px; height: 300px; pointer-events: none; overflow: hidden; }
        .heart { position: absolute; bottom: 0; right: 10px; font-size: 1.5rem; animation: floatUp 2s linear forwards; opacity: 0; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(0.5); opacity: 1; } 100% { transform: translateY(-200px) scale(1.5) rotate(20deg); opacity: 0; } }
        .chat-panel { background: white; display: flex; flex-direction: column; border-left: 1px solid #333; }
        .chat-header { padding: 15px; background: white; border-bottom: 1px solid #e2e8f0; color: var(--dark); font-weight: 700; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #f8fafc; }
        .msg { font-size: 0.9rem; line-height: 1.4; color: #334155; animation: slideIn 0.3s; padding: 8px 12px; border-radius: 8px; background: white; border: 1px solid #e2e8f0; width: fit-content; max-width: 90%; }
        .msg b { color: var(--primary); margin-right: 5px; font-weight: 700; }
        .msg.me { align-self: flex-end; background: #dcfce7; border-color: #86efac; }
        .msg.me b { color: var(--primary-dark); }
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .chat-input-area { padding: 15px; background: white; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; }
        .input-box { flex: 1; padding: 10px 15px; border-radius: 50px; border: 1px solid #cbd5e1; outline: none; }
        .input-box:focus { border-color: var(--primary); }
        .btn-send { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: transform 0.2s; }
        .btn-send:hover { transform: scale(1.1); }
        @media (max-width: 900px) { .live-container { grid-template-columns: 1fr; grid-template-rows: 40vh 1fr; } .chat-panel { border-left: none; border-top: 1px solid #333; } }
    </style>
</head>
<body>

    <div class="live-container">
        
        <div class="stage-area">
            <div class="video-wrapper" id="videoContainer">
                <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#000;">
                    <i class="fas fa-spinner fa-spin fa-3x"></i>
                </div>
            </div>

            <div class="overlay-ui">
                <div class="top-bar">
                    <a href="coaching-stream.html" class="back-btn"><i class="fas fa-chevron-left"></i> Keluar</a>
                    <div style="text-align: right;">
                        <div class="live-badge">LIVE</div>
                        <div class="viewer-count"><i class="fas fa-eye"></i> <span id="viewCount">...</span></div>
                    </div>
                </div>

                <div class="hearts-container" id="heartsContainer"></div>

                <div class="bottom-bar">
                    <div class="mentor-profile">
                        <img id="mentorImg" src="" class="mentor-img">
                        <div>
                            <h3 id="mentorName" style="margin:0; font-size:1rem;">Loading...</h3>
                            <p id="streamTitle" style="margin:0; font-size:0.8rem; opacity:0.8;">...</p>
                        </div>
                        <button onclick="window.location.href='coaching-stream.html'" style="margin-left:10px; background:var(--accent); border:none; color:white; padding:5px 15px; border-radius:50px; font-weight:bold; cursor:pointer;">Booking</button>
                    </div>

                    <div class="floating-actions">
                        <button class="action-btn" id="muteBtn" onclick="toggleMute(this)" style="display:none;"><i class="fas fa-volume-mute"></i></button>
                        <button class="action-btn btn-love" onclick="spamLove()"><i class="fas fa-heart"></i></button>
                        <button class="action-btn"><i class="fas fa-share"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-panel">
            <div class="chat-header">Live Chat</div>
            
            <div class="chat-messages" id="chatList">
                <div class="msg" style="color:#94a3b8; text-align:center; font-size:0.8rem; background:none; border:none; width:100%;">
                    Memuat ruang chat...
                </div>
            </div>

            <div class="chat-input-area">
                <input type="text" id="chatInput" class="input-box" placeholder="Ketik komentar..." onkeypress="handleEnter(event)">
                <button class="btn-send" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, limit, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIaLzkNM0KqPVKxuMNmardLqcrr2kYTWQ",
            authDomain: "database-idbm.firebaseapp.com",
            projectId: "database-idbm",
            storageBucket: "database-idbm.firebasestorage.app",
            messagingSenderId: "1052290789133",
            appId: "1:1052290789133:web:36b513630b7a87154eca44",
            measurementId: "G-EQLBB94DY2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = { name: "Guest" };
        let activeStreamId = null; // ID ini akan diisi otomatis agar chat beda-beda

        // --- FUNGSI PARSER YOUTUBE ---
        function getYouTubeID(url) {
            if (!url) return null;
            url = url.trim();
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // --- FUNGSI MEMBUAT ROOM ID DARI URL VIDEO (KUNCI AGAR CHAT UNIK) ---
        function generateRoomIdFromUrl(url) {
            if (!url) return "default_room";
            
            // Jika YouTube, gunakan ID Videonya (Paling Aman)
            const ytId = getYouTubeID(url);
            if (ytId) return "chat_" + ytId;

            // Jika Video Biasa (MP4), gunakan nama filenya yang dibersihkan
            // Contoh: https://site.com/videos/materi-1.mp4 -> chat_materi-1
            try {
                const filename = url.substring(url.lastIndexOf('/') + 1).split('?')[0];
                return "chat_" + filename.replace(/[^a-zA-Z0-9-_]/g, '');
            } catch (e) {
                return "chat_general"; // Fallback jika URL aneh
            }
        }

        // --- 1. INISIALISASI ---
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const src = params.get('src'); // Link Video
            const roomIDParam = params.get('roomID'); // ID dari CMS (jika ada)
            
            // --- LOGIKA UTAMA PENENTUAN ROOM CHAT ---
            if (roomIDParam) {
                activeStreamId = roomIDParam; // Prioritas 1: ID dari CMS
            } else if (src) {
                activeStreamId = generateRoomIdFromUrl(src); // Prioritas 2: ID dari Link Video
            } else {
                activeStreamId = "default_room"; // Fallback
            }
            
            console.log("Connected to Chat Room:", activeStreamId); // Cek Console (F12)

            // Setup UI Info
            const title = params.get('title');
            const mentor = params.get('mentor');
            const viewers = params.get('viewers');

            if(mentor) {
                document.getElementById('mentorName').innerText = mentor;
                document.getElementById('mentorImg').src = `https://ui-avatars.com/api/?name=${mentor}&background=random&color=fff`;
            }
            if(title) document.getElementById('streamTitle').innerText = title;
            if(viewers) document.getElementById('viewCount').innerText = viewers;

            // Setup Player
            const container = document.getElementById('videoContainer');
            if (src) {
                const videoId = getYouTubeID(src);
                const origin = window.location.origin; 

                if (videoId) {
                    container.innerHTML = `
                        <iframe 
                            src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0&controls=1&loop=1&playlist=${videoId}&origin=${origin}&playsinline=1" 
                            title="Live Stream" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                            referrerpolicy="strict-origin-when-cross-origin" 
                            allowfullscreen>
                        </iframe>`;
                    if(document.getElementById('muteBtn')) document.getElementById('muteBtn').style.display = 'none'; 
                } else {
                    container.innerHTML = `
                        <video class="custom-video-player" autoplay loop muted playsinline>
                            <source src="${src}" type="video/mp4">
                            Browser Anda tidak mendukung tag video.
                        </video>`;
                    if(document.getElementById('muteBtn')) document.getElementById('muteBtn').style.display = 'flex'; 
                }
            } else {
                container.innerHTML = `<div style="color:white; text-align:center;">Link video tidak ditemukan.</div>`;
            }

            // Panggil Chat Listener setelah ID Room fix
            initChatListener();
        };

        // --- 2. AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const docSnap = await getDoc(doc(db, "users_umkm", user.uid));
                if (docSnap.exists()) {
                    userData = { name: docSnap.data().nama_lengkap, uid: user.uid };
                }
            } else {
                userData = { name: "Guest User", uid: "guest_" + Math.floor(Math.random() * 1000) };
            }
        });

        // --- 3. CHAT LOGIC ---
        function initChatListener() {
            if (!activeStreamId) return;

            const q = query(
                collection(db, "live_chats", activeStreamId, "messages"), // Menggunakan ID Unik
                orderBy("timestamp", "asc"), 
                limit(50)
            );
            
            onSnapshot(q, (snapshot) => {
                const chatList = document.getElementById('chatList');
                if(snapshot.empty) {
                    chatList.innerHTML = `<div class="msg" style="color:#94a3b8; text-align:center; font-size:0.8rem; background:none; border:none; width:100%;">Belum ada pesan. Jadilah yang pertama!</div>`;
                    return;
                }
                chatList.innerHTML = ""; 
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const isMe = (data.uid === userData.uid); 
                    const div = document.createElement('div');
                    div.className = isMe ? "msg me" : "msg";
                    div.innerHTML = `<b>${data.name}:</b> ${data.text}`;
                    chatList.appendChild(div);
                });
                chatList.scrollTop = chatList.scrollHeight;
            });
        }

        window.sendChat = async () => {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text || !activeStreamId) return;
            input.value = ""; 

            try {
                await addDoc(collection(db, "live_chats", activeStreamId, "messages"), {
                    text: text, name: userData.name, uid: userData.uid, timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Gagal kirim chat", e);
            }
        }

        window.handleEnter = (e) => { if(e.key === 'Enter') window.sendChat(); }

        window.spamLove = () => {
            const container = document.getElementById('heartsContainer');
            const heart = document.createElement('div');
            heart.innerHTML = "❤️";
            heart.className = "heart";
            heart.style.left = Math.random() * 50 + "px";
            container.appendChild(heart);
            setTimeout(() => { heart.remove(); }, 2000);
        }

        window.toggleMute = (btn) => {
            const video = document.querySelector('video');
            if(video) {
                if(video.muted) {
                    video.muted = false;
                    btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                } else {
                    video.muted = true;
                    btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                }
            }
        }

        setInterval(() => {
            const el = document.getElementById('viewCount');
            if(el) {
                let currentStr = el.innerText.replace(/,/g, '');
                let current = isNaN(parseInt(currentStr)) ? 100 : parseInt(currentStr);
                const change = Math.floor(Math.random() * 10) - 4; 
                el.innerText = (current + change).toLocaleString();
            }
        }, 3000);

    </script>
</body>
</html>