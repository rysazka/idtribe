<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Partnership Hub - ID-TRIBE</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

    <style>
        /* --- 1. BASE STYLES --- */
        :root {
            --primary: #059669; --primary-dark: #047857; --primary-light: #d1fae5;
            --accent: #f59e0b; --dark: #0f172a; --text-gray: #64748b; --border: #e2e8f0;
            --font-head: 'Outfit', sans-serif; --font-body: 'Plus Jakarta Sans', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: var(--font-body); background-color: #f0fdf4; color: var(--dark);
            padding-top: 80px; padding-bottom: 100px; min-height: 100vh;
            background-image: radial-gradient(at 0% 0%, hsla(152,100%,93%,1) 0, transparent 50%), 
                              radial-gradient(at 100% 100%, hsla(43,100%,93%,1) 0, transparent 50%);
        }

        /* NAVIGATION */
        .top-nav {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.6); display: flex; align-items: center; justify-content: space-between;
            padding: 0 5%; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }
        .brand { font-family: var(--font-head); font-size: 1.4rem; font-weight: 800; color: var(--dark); text-decoration: none; }
        .brand span { color: var(--primary); }
        .nav-back { text-decoration: none; color: var(--text-gray); font-weight: 600; display: flex; align-items: center; gap: 8px; }

        .main-container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
        
        /* TABS */
        .tab-switcher { display: flex; gap: 10px; margin-bottom: 30px; justify-content: center; flex-wrap: wrap; }
        .tab-btn {
            padding: 10px 25px; border-radius: 30px; border: none; font-weight: 700; cursor: pointer;
            font-family: var(--font-body); transition: 0.3s; background: rgba(255,255,255,0.6); color: var(--text-gray);
        }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(5,150,105,0.3); }

        .view-section { display: none; animation: fadeIn 0.4s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* FILTER BAR */
        .filter-container { 
            max-width: 900px; margin: 0 auto 30px auto; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
            background: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }
        .search-input, .filter-select { padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; outline: none; font-family: var(--font-body); font-size: 0.9rem; }
        .search-input { flex: 2; min-width: 200px; } .filter-select { flex: 1; min-width: 140px; cursor: pointer; }
        
        /* --- MARKETPLACE CARD (GRID) --- */
        .partner-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        
        .partner-card {
            background: white; border-radius: 16px; padding: 20px; border: 1px solid #f1f5f9;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; flex-direction: column; position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.02); overflow: hidden;
        }
        .partner-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.06); }
        .border-top-card { border-top: 5px solid var(--primary); } /* Untuk tab bursa */

        .card-image-space {
            width: 100%; height: 180px; background: #f8fafc; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; color: #cbd5e1;
            margin-bottom: 15px; overflow: hidden; border: 1px solid #e2e8f0; cursor: pointer;
        }
        .card-image-space img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-head { display: flex; align-items: center; gap: 12px; cursor: pointer; margin-bottom:10px; }
        .card-avatar { width: 45px; height: 45px; background: var(--primary-light); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.1rem; color: var(--primary-dark); flex-shrink: 0; }
        
        .badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 6px; font-weight: 700; text-transform: uppercase; display: inline-block; }
        .badge-umkm { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; margin-bottom: 10px; }
        
        /* DESAIN TOMBOL EDIT & DELETE (SEPERTI DI GAMBAR) */
        .card-buttons { display: flex; gap: 10px; margin-top: auto; padding-top: 10px; }
        
        .btn-card { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: 0.3s; background: #f8fafc; color: var(--dark); border: 1px solid #e2e8f0; }
        .btn-card:hover { background: var(--dark); color: white; border-color: var(--dark); }
        
        .btn-edit { 
            flex: 1; padding: 10px; border-radius: 50px; border: 1px solid #bfdbfe;
            background: #eff6ff; color: #2563eb; font-weight: 700; font-size: 0.9rem;
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-edit:hover { background: #dbeafe; color: #1d4ed8; border-color:#93c5fd; }
        
        .btn-delete { 
            width: 45px; border-radius: 50px; border: 1px solid #fecaca;
            background: #fee2e2; color: #dc2626; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
        }
        .btn-delete:hover { background: #fca5a5; color: white; border-color:#f87171; }

        /* --- STATUS LIST STYLES --- */
        .status-container { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        .request-card {
            background: white; border-radius: 12px; padding: 20px;
            display: flex; flex-direction: column; gap: 5px; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #f1f5f9;
            border-left: 6px solid #cbd5e1; 
            transition: transform 0.2s; position: relative;
        }
        .request-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }

        .req-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .req-partner-name { font-family: var(--font-head); font-weight: 700; font-size: 1rem; color: var(--dark); display: flex; align-items: center; gap: 8px; }

        .dir-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600; text-transform: uppercase; }
        .dir-in { background: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; } 
        .dir-out { background: #f3f4f6; color: #64748b; border: 1px solid #e5e7eb; }

        .status-pill { font-size: 0.7rem; padding: 4px 12px; border-radius: 20px; font-weight: 700; text-transform: capitalize; }
        .st-review { background: #fef3c7; color: #d97706; } 
        .st-active { background: #dcfce7; color: #166534; } 
        .st-rejected { background: #f3f4f6; color: #64748b; } 
        .br-review { border-left-color: #f59e0b; }
        .br-active { border-left-color: #10b981; }
        .br-rejected { border-left-color: #94a3b8; opacity: 0.7; }
        .req-title { font-weight: 600; font-size: 0.9rem; color: #334155; }
        .req-date { font-size: 0.75rem; color: #94a3b8; margin-top: 2px; }

        /* FORM POPUP & FULL PAGE FORMS */
        .form-container { max-width: 600px; margin: 0 auto; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        .form-input, .form-textarea { width: 100%; padding: 14px; border: 1px solid #cbd5e1; border-radius: 12px; margin-bottom: 18px; outline:none; font-family: inherit; font-size: 0.95rem;}
        .form-input:focus, .form-textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .btn-primary { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.3s;}
        .btn-primary:hover { background: var(--primary-dark); }

        /* FAB & MODAL BUAT BARU */
        .fab-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 2000; }
        .fab-btn { width: 65px; height: 65px; border-radius: 50%; border: none; background: linear-gradient(135deg, var(--primary), #34d399); color: white; font-size: 2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4); cursor: pointer; transition: 0.3s; }
        .fab-btn:hover { transform: scale(1.1); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s ease; }
        .upload-card { background: white; width: 100%; max-width: 500px; border-radius: 24px; padding: 30px; max-height: 90vh; overflow-y: auto; position: relative; }
        .img-preview { width: 100%; height: 180px; object-fit: cover; border-radius: 12px; display: none; margin-bottom: 15px; border: 2px dashed #cbd5e1; }
        .img-preview.active { display: block; }
    </style>
</head>
<body>

    <nav class="top-nav">
        <a href="dashboard.html" class="nav-back"><i class="fas fa-arrow-left"></i> Dashboard</a>
        <div class="brand">ID<span>TRIBE</span></div>
        <div style="width: 80px;"></div>
    </nav>

    <div class="main-container">
        
        <div class="tab-switcher" id="mainTabSwitcher">
            <button class="tab-btn active" onclick="switchTab('marketplace')" id="btn-market">Bursa Peluang</button>
            <button class="tab-btn" onclick="switchTab('my-opps')" id="btn-my-opps">Peluang Saya</button>
            <button class="tab-btn" onclick="switchTab('status')" id="btn-status">Status Pengajuan</button>
        </div>

        <div id="view-marketplace" class="view-section active">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="font-family: var(--font-head); font-size: 1.8rem; margin-bottom: 5px;">Bursa Kolaborasi</h2>
                <p style="color: var(--text-gray);">Temukan peluang dari Partner, BUMN, Pemerintah, dan Kampus.</p>
            </div>
            
            <div class="filter-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Cari Peluang..." onkeyup="applyFilter()">
                <select id="filterType" class="filter-select" onchange="applyFilter()">
                    <option value="">Semua Institusi</option>
                    <option value="UMKM">UMKM</option>
                    <option value="BUMN">BUMN</option>
                    <option value="Government">Pemerintah</option>
                </select>
                <select id="filterCategory" class="filter-select" onchange="applyFilter()">
                    <option value="">Semua Kategori</option>
                    <option value="F&B">F&B</option>
                    <option value="Teknologi">Teknologi</option>
                    <option value="Jasa">Jasa</option>
                </select>
            </div>
            
            <div id="loadingGrid" style="text-align:center; padding:40px; color:gray;">
                <i class="fas fa-circle-notch fa-spin"></i> Memuat Data...
            </div>
            <div class="partner-grid" id="partnerGrid"></div>
        </div>

        <div id="view-my-opps" class="view-section">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="font-family: var(--font-head); font-size: 1.8rem; margin-bottom: 5px;">Peluang Saya</h2>
                <p style="color: var(--text-gray);">Kelola postingan peluang kolaborasi yang telah Anda buat.</p>
            </div>
            <div class="partner-grid" id="myOppGrid">
                <div style="text-align:center; grid-column:1/-1; padding:40px; color:gray;">
                    <i class="fas fa-circle-notch fa-spin"></i> Memuat data Anda...
                </div>
            </div>
        </div>

        <div id="view-status" class="view-section">
            <div style="max-width: 800px; margin: 0 auto;">
                <div class="filter-container" style="margin-bottom:20px;">
                    <select id="filterStatusType" class="search-input" onchange="renderStatusLists()">
                        <option value="all">Semua Status</option>
                        <option value="in">Masuk (Incoming)</option>
                        <option value="out">Keluar (Outgoing)</option>
                    </select>
                </div>

                <h4 style="color:#059669; margin: 20px 0 10px 0; font-family:var(--font-head);"><i class="fas fa-handshake"></i> Partnership Aktif <span id="count-active" style="background:#059669; color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem;">0</span></h4>
                <div id="list-active" class="status-container"></div>

                <h4 style="color:#f59e0b; margin: 30px 0 10px 0; font-family:var(--font-head);"><i class="fas fa-clock"></i> Dalam Proses <span id="count-pending" style="background:#f59e0b; color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem;">0</span></h4>
                <div id="list-pending" class="status-container"></div>

                <h4 style="color:#64748b; margin: 30px 0 10px 0; font-family:var(--font-head);"><i class="fas fa-history"></i> Riwayat <span id="count-history" style="background:#64748b; color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem;">0</span></h4>
                <div id="list-history" class="status-container"></div>
            </div>
        </div>

        <div id="view-form" class="view-section">
            <div class="form-container">
                <button onclick="switchTab('marketplace')" style="background:none; border:none; color:var(--text-gray); cursor:pointer; margin-bottom:15px; font-weight:600;"><i class="fas fa-arrow-left"></i> Kembali</button>
                <h2 style="font-family: var(--font-head); margin-bottom: 20px; font-size: 1.8rem;">Formulir Pengajuan</h2>
                <form onsubmit="submitProposal(event)">
                    <input type="hidden" id="formTargetID"> 
                    <label style="font-weight: 700; display: block; margin-bottom: 5px;">Target Partner</label>
                    <input type="text" id="formTargetName" class="form-input" readonly style="background: #f8fafc; font-weight: 600; color:var(--text-gray);">
                    
                    <label style="font-weight: 700; display: block; margin-bottom: 5px;">Judul Kerjasama</label>
                    <input type="text" id="formTitle" class="form-input" placeholder="Tuliskan judul penawaran..." required>
                    
                    <label style="font-weight: 700; display: block; margin-bottom: 5px;">Pesan / Proposal Singkat</label>
                    <textarea id="formDesc" class="form-textarea" rows="5" required placeholder="Jelaskan detail kolaborasi yang Anda inginkan..."></textarea>
                    
                    <button type="submit" class="btn-primary">Kirim Pengajuan</button>
                </form>
            </div>
        </div>

        <div id="view-edit-opp" class="view-section">
            <div class="form-container">
                <button onclick="closeEditForm()" style="background:none; border:none; color:var(--text-gray); cursor:pointer; margin-bottom:15px; font-weight:600;"><i class="fas fa-arrow-left"></i> Batal Edit</button>
                <h2 style="font-family: var(--font-head); margin-bottom: 20px; font-size: 1.8rem; color:var(--primary);">Edit Peluang</h2>
                
                <img id="editPagePreviewImg" class="img-preview">
                <label style="font-weight:700; font-size:0.9rem; display:block; margin-bottom:5px;">Update Foto (Abaikan jika tidak ingin mengubah)</label>
                <input type="file" id="editPageOppImage" accept="image/*" class="form-input" onchange="previewImage(this, 'editPagePreviewImg')" style="margin-bottom:20px;">

                <label style="font-weight:700; font-size:0.9rem; display:block; margin-bottom:5px;">Judul Peluang</label>
                <input type="text" id="editPageOppTitle" class="form-input" placeholder="Tulis judul yang menarik...">
                
                <label style="font-weight:700; font-size:0.9rem; display:block; margin-bottom:5px;">Kategori</label>
                <select id="editPageOppCat" class="form-input">
                    <option value="Jasa">Jasa</option><option value="Teknologi">Teknologi</option><option value="F&B">F&B</option>
                </select>
                
                <label style="font-weight:700; font-size:0.9rem; display:block; margin-bottom:5px;">Deskripsi Lengkap</label>
                <textarea id="editPageOppDesc" class="form-textarea" rows="5" placeholder="Jelaskan detail peluang..."></textarea>
                
                <button class="btn-primary" id="btnPageUpdate" onclick="updateOpportunityPage()">Simpan Perubahan</button>
            </div>
        </div>

    </div>

    <div class="fab-container">
        <button class="fab-btn" onclick="openUploadModal()" title="Posting Peluang Baru"><i class="fas fa-plus"></i></button>
    </div>

    <div class="modal-overlay" id="uploadModal">
        <div class="upload-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 style="margin:0; font-family:var(--font-head); font-size:1.5rem;">Buat Peluang Baru</h3>
                <button onclick="closeUploadModal()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <img id="previewImg" class="img-preview">
            <label style="font-weight:700; font-size:0.9rem; display:block; margin-bottom:5px;">Foto (Opsional)</label>
            <input type="file" id="newOppImage" accept="image/*" class="form-input" onchange="previewImage(this, 'previewImg')" style="margin-bottom:15px;">

            <input type="text" id="newOppTitle" class="form-input" placeholder="Judul Peluang">
            <select id="newOppCat" class="form-input">
                <option value="Jasa">Jasa</option><option value="Teknologi">Teknologi</option><option value="F&B">F&B</option>
            </select>
            <textarea id="newOppDesc" class="form-textarea" rows="3" placeholder="Deskripsi..."></textarea>
            <button class="btn-primary" id="btnPublish" onclick="publishOpportunity()">Posting Sekarang</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, doc, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // GANTI DENGAN CONFIG FIREBASE ANDA
        const firebaseConfig = {
            apiKey: "AIzaSyBIaLzkNM0KqPVKxuMNmardLqcrr2kYTWQ",
            authDomain: "database-idbm.firebaseapp.com",
            projectId: "database-idbm",
            storageBucket: "database-idbm.firebasestorage.app",
            messagingSenderId: "1052290789133",
            appId: "1:1052290789133:web:36b513630b7a87154eca44",
            measurementId: "G-EQLBB94DY2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentUserData = null;
        let partnersData = []; 
        let requestsData = []; 
        let currentEditDocId = null;

        // --- AUTH & INITIAL LOAD ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const docRef = doc(db, "users_umkm", user.uid);
                const docSnap = await getDoc(docRef);
                if(docSnap.exists()) currentUserData = docSnap.data();

                setupPartnersListener();
                setupStatusListener();

                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('action') === 'apply') {
                    openProposalForm(urlParams.get('id'), decodeURIComponent(urlParams.get('target') || ''), decodeURIComponent(urlParams.get('title') || ''));
                }
            } else {
                window.location.href = "login.html";
            }
        });

        // --- PENGATUR TABS ---
        window.switchTab = (t) => {
            // Sembunyikan semua tab button
            document.getElementById('mainTabSwitcher').style.display = 'flex';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            // Sembunyikan semua view section
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active')); 
            
            // Atur yang aktif
            if(t === 'marketplace') {
                document.getElementById('btn-market').classList.add('active');
                document.getElementById('view-marketplace').classList.add('active');
            } else if (t === 'status') {
                document.getElementById('btn-status').classList.add('active');
                document.getElementById('view-status').classList.add('active');
            } else if (t === 'my-opps') {
                document.getElementById('btn-my-opps').classList.add('active');
                document.getElementById('view-my-opps').classList.add('active');
            }
        }

        // =========================================================
        // LOGIKA DATA: BURSA PELUANG & PELUANG SAYA
        // =========================================================
        
        function setupPartnersListener() {
            const loading = document.getElementById('loadingGrid');
            const q = collection(db, "opportunities"); 
            
            onSnapshot(q, (snap) => {
                if(loading) loading.style.display = 'none';
                partnersData = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    partnersData.push({...d, id: d.ownerId, docId: doc.id}); 
                });
                
                partnersData.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                renderPartnerGrid(partnersData); 
                renderMyOpportunities();         
            }, (error) => {
                if(loading) loading.innerHTML = `<span style='color:red'>Gagal memuat: ${error.message}</span>`;
            });
        }

        // --- TAB 1: RENDER BURSA PELUANG (SEMUA ORANG) ---
        function renderPartnerGrid(data) {
            const grid = document.getElementById('partnerGrid');
            grid.innerHTML = "";
            if(data.length === 0) { grid.innerHTML = "<p style='text-align:center; grid-column:1/-1; color:gray;'>Belum ada peluang yang cocok.</p>"; return; }

            data.forEach(p => {
                let borderColor = "var(--primary)";
                if(p.role === 'BUMN') borderColor = "#1d4ed8";
                
                let imgContent = `<i class="fas fa-handshake" style="font-size:3rem; opacity:0.3;"></i>`;
                if(p.image) imgContent = `<img src="${p.image}" alt="Img">`;

                grid.innerHTML += `
                <div class="partner-card border-top-card" style="border-top-color: ${borderColor}">
                    <div class="card-image-space" onclick="window.location.href='partner-profile.html?id=${p.id}'">${imgContent}</div>
                    <div class="card-head" onclick="window.location.href='partner-profile.html?id=${p.id}'">
                        <div class="card-avatar">${p.ownerName?p.ownerName.charAt(0):'U'}</div>
                        <div><h4 style="margin-bottom:2px;">${p.title}</h4><span style="font-size:0.8rem;">${p.ownerName}</span></div>
                    </div>
                    <div style="margin-top:5px;"><span class="badge badge-umkm">${p.role}</span></div>
                    <div class="card-buttons">
                        <button class="btn-card" onclick="window.location.href='partner-profile.html?id=${p.id}'">Lihat Profil</button>
                    </div>
                </div>`;
            });
        }

        // --- TAB 2: RENDER PELUANG SAYA (HANYA MILIK USER) ---
        function renderMyOpportunities() {
            const grid = document.getElementById('myOppGrid');
            if(!grid) return;
            grid.innerHTML = "";

            if(!currentUser) return;
            const myOpps = partnersData.filter(p => p.ownerId === currentUser.uid);

            if(myOpps.length === 0) {
                grid.innerHTML = `
                    <div style='text-align:center; grid-column:1/-1; padding:50px; background:white; border-radius:24px; border:1px dashed #cbd5e1;'>
                        <i class="fas fa-box-open fa-3x" style='margin-bottom:15px; color:#cbd5e1;'></i>
                        <h3 style="color:var(--dark);">Peluang Kosong</h3>
                        <p style="color:var(--text-gray);">Anda belum pernah membuat peluang kerjasama.<br>Klik tombol + di pojok kanan bawah untuk mempublikasikan peluang pertama Anda.</p>
                    </div>`;
                return;
            }

            myOpps.forEach(p => {
                let imgContent = `<i class="fas fa-image fa-3x" style="opacity:0.3;"></i>`;
                if(p.image) imgContent = `<img src="${p.image}" alt="Img">`;

                grid.innerHTML += `
                <div class="partner-card" style="border: 1px solid #e2e8f0; border-top: none;">
                    <div class="card-image-space" style="height:180px; border-radius:12px;">${imgContent}</div>
                    
                    <div style="flex:1;">
                        <h4 style="font-size: 1.1rem; color: var(--dark); margin-bottom: 5px; line-height: 1.3;">${p.title}</h4>
                        <span style="font-size:0.8rem; color:var(--text-gray); display:flex; align-items:center; gap:5px;"><i class="fas fa-tag"></i> ${p.category}</span>
                    </div>

                    <div class="card-buttons">
                        <button class="btn-edit" onclick="openEditForm('${p.docId}')"><i class="fas fa-pen"></i> Edit</button>
                        <button class="btn-delete" onclick="deleteOpportunity('${p.docId}')" title="Hapus"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });
        }

        // =========================================================
        // LOGIKA CRUD (CREATE, UPDATE, DELETE)
        // =========================================================

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error);
        });

        window.previewImage = (input, imgElementId) => {
            if(input.files && input.files[0]){
                const reader = new FileReader();
                reader.onload = (e) => { 
                    const img = document.getElementById(imgElementId);
                    img.src = e.target.result; img.classList.add('active'); 
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- CREATE (MODAL) ---
        window.openUploadModal = () => document.getElementById('uploadModal').classList.add('active');
        window.closeUploadModal = () => { 
            document.getElementById('uploadModal').classList.remove('active'); 
            document.getElementById('newOppImage').value = ""; 
            document.getElementById('previewImg').classList.remove('active'); 
        }

        window.publishOpportunity = async () => {
            const btn = document.getElementById('btnPublish');
            const title = document.getElementById('newOppTitle').value;
            const cat = document.getElementById('newOppCat').value;
            const desc = document.getElementById('newOppDesc').value;
            const fileInput = document.getElementById('newOppImage');

            if(!title) { Swal.fire('Oops', 'Judul peluang harus diisi!', 'warning'); return; }
            btn.innerText = "Proses..."; btn.disabled = true;

            try {
                let imageBase64 = null;
                if(fileInput.files.length > 0) imageBase64 = await toBase64(fileInput.files[0]);

                await addDoc(collection(db, "opportunities"), {
                    ownerId: currentUser.uid, ownerName: currentUserData?.nama_usaha || "UMKM",
                    title, desc, category: cat, role: currentUserData?.role || "UMKM",
                    image: imageBase64, createdAt: serverTimestamp()
                });
                
                closeUploadModal();
                Swal.fire('Sukses', 'Peluang berhasil dipublikasikan!', 'success');
                switchTab('my-opps'); 
                
            } catch(e) { Swal.fire('Error', e.message, 'error'); } 
            finally { btn.innerText = "Posting Sekarang"; btn.disabled = false; }
        }

        // --- UPDATE (FULL PAGE FORM) ---
        window.openEditForm = (docId) => {
            const opp = partnersData.find(p => p.docId === docId);
            if(!opp) return;

            currentEditDocId = docId;
            document.getElementById('editPageOppTitle').value = opp.title;
            document.getElementById('editPageOppCat').value = opp.category;
            document.getElementById('editPageOppDesc').value = opp.desc;

            const preview = document.getElementById('editPagePreviewImg');
            if(opp.image) { preview.src = opp.image; preview.classList.add('active'); } 
            else { preview.src = ""; preview.classList.remove('active'); }

            // Sembunyikan tab switcher & Tampilkan Form Edit
            document.getElementById('mainTabSwitcher').style.display = 'none';
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById('view-edit-opp').classList.add('active');
            
            // Scroll ke atas
            window.scrollTo(0,0);
        }

        window.closeEditForm = () => {
            currentEditDocId = null;
            document.getElementById('editPageOppImage').value = "";
            switchTab('my-opps'); // Kembali ke Peluang Saya
        }

        window.updateOpportunityPage = async () => {
            if(!currentEditDocId) return;

            const btn = document.getElementById('btnPageUpdate');
            const title = document.getElementById('editPageOppTitle').value;
            const cat = document.getElementById('editPageOppCat').value;
            const desc = document.getElementById('editPageOppDesc').value;
            const fileInput = document.getElementById('editPageOppImage');

            if(!title) { Swal.fire('Oops', 'Judul peluang tidak boleh kosong!', 'warning'); return; }
            btn.innerText = "Menyimpan..."; btn.disabled = true;

            try {
                let updateData = { title: title, category: cat, desc: desc };

                if(fileInput.files.length > 0) {
                    const imageBase64 = await toBase64(fileInput.files[0]);
                    updateData.image = imageBase64;
                }

                await updateDoc(doc(db, "opportunities", currentEditDocId), updateData);
                closeEditForm();
                Swal.fire('Sukses', 'Perubahan berhasil disimpan!', 'success');
            } catch(e) { Swal.fire('Error', e.message, 'error'); } 
            finally { btn.innerText = "Simpan Perubahan"; btn.disabled = false; }
        }

        // --- DELETE ---
        window.deleteOpportunity = async (docId) => {
            const result = await Swal.fire({
                title: 'Hapus Peluang?', text: "Data tidak bisa dikembalikan!", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#ef4444', cancelButtonColor: '#64748b',
                confirmButtonText: 'Hapus', cancelButtonText: 'Batal'
            });

            if (result.isConfirmed) {
                try {
                    await deleteDoc(doc(db, "opportunities", docId));
                    Swal.fire('Terhapus!', 'Peluang telah dihapus.', 'success');
                } catch (error) { Swal.fire('Gagal', error.message, 'error'); }
            }
        }

        // =========================================================
        // FILTER PENCARIAN (KHUSUS BURSA PELUANG)
        // =========================================================
        window.applyFilter = () => {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const typeValue = document.getElementById('filterType').value;
            const categoryValue = document.getElementById('filterCategory').value;

            const filtered = partnersData.filter(p => {
                const matchText = p.title.toLowerCase().includes(searchText) || (p.ownerName && p.ownerName.toLowerCase().includes(searchText));
                const matchType = typeValue === "" || p.role === typeValue;
                const matchCategory = categoryValue === "" || p.category === categoryValue;
                return matchText && matchType && matchCategory;
            });
            renderPartnerGrid(filtered);
        }

        // =========================================================
        // STATUS PENGAJUAN (APPLY) LOGIC
        // =========================================================
        function setupStatusListener() {
            const qOut = query(collection(db, "partnership_requests"), where("senderId", "==", currentUser.uid));
            onSnapshot(qOut, (snap) => updateLocalData(snap, 'out'));

            const qIn = query(collection(db, "partnership_requests"), where("targetId", "==", currentUser.uid));
            onSnapshot(qIn, (snap) => updateLocalData(snap, 'in'));
        }

        function updateLocalData(snapshot, direction) {
            snapshot.docChanges().forEach(change => {
                const data = change.doc.data();
                const id = change.doc.id;
                
                if (change.type === "removed") {
                    requestsData = requestsData.filter(r => r.id !== id);
                } else if (change.type === "added" || change.type === "modified") {
                    const idx = requestsData.findIndex(r => r.id === id);
                    const item = { ...data, id, direction };
                    if (idx > -1) requestsData[idx] = item; else requestsData.push(item);
                }
            });
            renderStatusLists();
        }

        window.renderStatusLists = () => {
            requestsData.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

            const listActive = document.getElementById('list-active');
            const listPending = document.getElementById('list-pending');
            const listHistory = document.getElementById('list-history');
            
            listActive.innerHTML = ""; listPending.innerHTML = ""; listHistory.innerHTML = "";
            let cAct = 0, cPen = 0, cHis = 0;

            const filterType = document.getElementById('filterStatusType')?.value || 'all';

            requestsData.forEach(req => {
                if(filterType !== 'all' && req.direction !== filterType) return;

                let container, statusClass, borderClass, statusLabel;
                
                if (req.status === 'accepted' || req.status === 'active') {
                    container = listActive; statusClass = 'st-active'; borderClass = 'br-active'; statusLabel = 'Aktif'; cAct++;
                } else if (req.status === 'pending' || req.status === 'review') {
                    container = listPending; statusClass = 'st-review'; borderClass = 'br-review'; statusLabel = 'Review'; cPen++;
                } else {
                    container = listHistory; statusClass = 'st-rejected'; borderClass = 'br-rejected'; statusLabel = req.status; cHis++;
                }

                const partnerName = req.direction === 'in' ? req.senderName : req.targetName;
                const dirBadgeClass = req.direction === 'in' ? 'dir-in' : 'dir-out';
                const dirText = req.direction === 'in' ? 'Masuk' : 'Keluar';
                const dateStr = req.createdAt?.toDate ? req.createdAt.toDate().toLocaleDateString() : "Baru Saja";

                const html = `
                <div class="request-card ${borderClass}" onclick="window.location.href='request-detail.html?id=${req.id}'">
                    <div class="req-top-row">
                        <div class="req-partner-name">${partnerName} <span class="dir-badge ${dirBadgeClass}">${dirText}</span></div>
                        <span class="status-pill ${statusClass}">${statusLabel}</span>
                    </div>
                    <div class="req-title">${req.title}</div>
                    <div class="req-date">${dateStr}</div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });

            document.getElementById('count-active').innerText = cAct;
            document.getElementById('count-pending').innerText = cPen;
            document.getElementById('count-history').innerText = cHis;
        }

        // FORM PENGAJUAN (APPLY KE ORANG LAIN)
        window.openProposalForm = (id, name, title) => {
            document.getElementById('mainTabSwitcher').style.display = 'none';
            document.querySelectorAll('.view-section').forEach(v=>v.classList.remove('active'));
            document.getElementById('view-form').classList.add('active');
            
            document.getElementById('formTargetID').value = id;
            document.getElementById('formTargetName').value = name;
            if(title) document.getElementById('formTitle').value = title;
        }
    </script>
</body>
</html>