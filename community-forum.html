<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Forum - ID-TRIBE</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

    <style>
        /* --- 1. MODERN THEME --- */
        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --accent: #f59e0b;
            --dark: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: 1px solid rgba(255, 255, 255, 0.6);
            --shadow: 0 10px 40px rgba(0,0,0,0.05);
            --font-head: 'Outfit', sans-serif;
            --font-body: 'Plus Jakarta Sans', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: var(--font-body); 
            background-color: #f0fdf4; 
            color: var(--dark); 
            height: 100vh; /* Fixed height for app-like feel */
            overflow: hidden; /* Prevent body scroll */
        }

        /* --- 2. ORNAMENTS --- */
        .bg-shapes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: float 10s infinite alternate; }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #d1fae5; }
        .blob-2 { bottom: 10%; right: -5%; width: 400px; height: 400px; background: #fef3c7; animation-delay: -5s; }
        @keyframes float { 0% { transform: translate(0, 0); } 100% { transform: translate(30px, 50px); } }

        /* --- 3. LAYOUT GRID --- */
        .container { 
            max-width: 1200px; margin: 0 auto; padding: 20px; 
            display: grid; grid-template-columns: 280px 1fr; gap: 30px; 
            height: 100vh; 
        }
        
        /* SIDEBAR */
        .sidebar { 
            background: var(--glass-bg); backdrop-filter: blur(12px); 
            border-radius: 24px; padding: 25px; 
            display: flex; flex-direction: column; gap: 20px; 
            height: calc(100vh - 40px); overflow-y: auto;
            border: var(--glass-border); box-shadow: var(--shadow);
        }
        
        .back-btn { 
            color: var(--primary-dark); text-decoration: none; font-weight: 700; 
            display: flex; align-items: center; gap: 10px; padding: 10px 0; 
            font-family: var(--font-head); transition: 0.3s;
        }
        .back-btn:hover { transform: translateX(-5px); }
        
        .category-btn { 
            display: flex; align-items: center; gap: 12px; padding: 12px 15px; 
            border-radius: 12px; cursor: pointer; color: #64748b; transition: 0.2s; 
            font-weight: 600; background: transparent; border: 1px solid transparent; 
            width: 100%; text-align: left; font-family: inherit; 
        }
        .category-btn:hover { background: #f8fafc; border-color: #e2e8f0; }
        .category-btn.active { background: #ecfdf5; color: var(--primary); border-color: var(--primary); }
        
        .trending-box {
            background: linear-gradient(135deg, #fffbeb, #fff7ed); 
            padding: 20px; border-radius: 16px; 
            border: 1px solid #fcd34d; margin-top: auto;
        }
        .trend-item { padding: 10px 0; border-bottom: 1px dashed #e2e8f0; cursor: pointer; transition: 0.2s; }
        .trend-item:last-child { border-bottom: none; }
        .trend-item:hover { transform: translateX(5px); }
        .trend-title { font-size: 0.9rem; font-weight: 700; color: var(--dark); margin-bottom: 2px; line-height: 1.3; }
        .trend-stats { font-size: 0.75rem; color: var(--accent); font-weight: 600; }

        /* --- 4. MAIN FEED AREA --- */
        .main-feed { 
            position: relative; height: calc(100vh - 40px); 
            border-radius: 24px; overflow: hidden; /* Penting untuk scroll internal */
        }

        /* VIEW 1: FEED LIST */
        #feedView { height: 100%; display: flex; flex-direction: column; }
        
        .feed-header { 
            background: var(--glass-bg); padding: 15px 20px; border-radius: 50px; 
            display: flex; gap: 15px; align-items: center; border: var(--glass-border); 
            box-shadow: var(--shadow); backdrop-filter: blur(10px); margin-bottom: 20px;
            flex-shrink: 0;
        }
        .search-input { flex: 1; padding: 10px 15px; border: none; background: transparent; outline: none; font-family: inherit; font-size: 1rem; }
        .btn-create { background: var(--accent); color: white; border: none; padding: 10px 25px; border-radius: 50px; font-weight: 700; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); }
        
        #threadList { 
            overflow-y: auto; padding-bottom: 50px; scrollbar-width: thin; 
            flex-grow: 1; padding-right: 5px;
        }

        .thread-card { 
            background: white; border-radius: 20px; padding: 25px; margin-bottom: 15px;
            border: 1px solid #f1f5f9; cursor: pointer; transition: 0.3s; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
        }
        .thread-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-color: var(--primary); }
        .thread-title { font-family: var(--font-head); font-size: 1.2rem; font-weight: 800; color: var(--dark); margin-bottom: 8px; }
        .thread-preview { font-size: 0.95rem; color: #475569; line-height: 1.6; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .badge-cat { padding: 4px 12px; border-radius: 50px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* WARNA BADGE */
        .bg-pajak { background: #fee2e2; color: #ef4444; }
        .bg-izin { background: #e0f2fe; color: #0ea5e9; }
        .bg-pemasaran { background: #dcfce7; color: #166534; }
        .bg-umum { background: #f3f4f6; color: #64748b; }

        /* --- 5. VIEW 2: DETAIL THREAD (FIXED LAYOUT) --- */
        #detailView { 
            display: none; background: white; border-radius: 24px; 
            height: 100%; flex-direction: column; overflow: hidden; 
            box-shadow: var(--shadow);
        }

        /* Bagian Atas (Sticky) */
        .detail-top { 
            padding: 25px; border-bottom: 1px solid #f1f5f9; background: white; 
            z-index: 10; flex-shrink: 0;
        }
        
        /* Bagian Tengah (Scrollable) */
        .detail-scroll-area { 
            flex-grow: 1; overflow-y: auto; padding: 25px; background: #f8fafc;
        }

        /* Bagian Bawah (Input Komentar Sticky) */
        .detail-bottom { 
            padding: 20px; background: white; border-top: 1px solid #e2e8f0; 
            flex-shrink: 0;
        }

        .comment-bubble { 
            background: white; padding: 15px; border-radius: 12px 12px 12px 0; 
            margin-bottom: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            position: relative; margin-left: 10px;
        }
        .comment-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; }
        .comment-author { font-weight: 700; color: var(--primary-dark); }
        .comment-time { color: #94a3b8; font-size: 0.75rem; }
        .comment-text { font-size: 0.95rem; color: #334155; line-height: 1.5; }

        .input-group { display: flex; gap: 10px; }
        .input-box { flex: 1; padding: 12px 20px; border: 2px solid #e2e8f0; border-radius: 50px; outline: none; transition: 0.2s; font-family: inherit; }
        .input-box:focus { border-color: var(--primary); }
        .btn-send { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 90%; max-width: 500px; padding: 30px; border-radius: 24px; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: inherit; margin-bottom: 15px; outline: none; }
        
        /* MOBILE CSS */
        .mobile-header, .mobile-filter-bar, .fab-create { display: none; }
        
        @media (max-width: 768px) {
            body { padding: 0; height: 100%; } /* Reset body height for mobile scrolling */
            .container { grid-template-columns: 1fr; display: block; padding: 0; height: 100vh; }
            .sidebar, .feed-header { display: none; }
            
            .mobile-header { display: flex; padding: 15px; background: white; align-items: center; justify-content: space-between; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 50; }
            .mobile-filter-bar { display: flex; gap: 10px; overflow-x: auto; padding: 10px 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
            .mobile-chip { padding: 6px 14px; border-radius: 20px; background: white; border: 1px solid #e2e8f0; font-size: 0.85rem; white-space: nowrap; color: var(--text-gray); }
            .mobile-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
            
            .fab-create { display: flex; position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; background: var(--accent); border-radius: 50%; color: white; border: none; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); z-index: 90; align-items: center; justify-content: center; cursor: pointer; }
            
            .main-feed { height: calc(100vh - 110px); }
            #feedView { padding: 15px; padding-bottom: 80px; }
            
            #detailView { 
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                z-index: 200; border-radius: 0; display: none;
            }
        }
    </style>
</head>
<body>

    <div class="bg-shapes">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <div class="mobile-header">
        <a href="training-hub.html" style="color:var(--dark); font-size:1.2rem;"><i class="fas fa-arrow-left"></i></a>
        <h3 style="font-family:var(--font-head); font-weight:800; color:var(--primary);">Forum Diskusi</h3>
        <div style="width: 24px;"></div> 
    </div>

    <div class="mobile-filter-bar">
        <div class="mobile-chip active" onclick="filterThreadsMobile('all', this)">Semua</div>
        <div class="mobile-chip" onclick="filterThreadsMobile('Pemasaran', this)">Pemasaran</div>
        <div class="mobile-chip" onclick="filterThreadsMobile('Legalitas', this)">Legalitas</div>
        <div class="mobile-chip" onclick="filterThreadsMobile('Modal', this)">Modal</div>
    </div>

    <div class="container">
        
        <aside class="sidebar">
            <a href="training-hub.html" class="back-btn"><i class="fas fa-arrow-left"></i> Kembali ke Hub</a>
            
            <div style="margin-bottom: 10px;">
                <h3 style="font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 1px; font-weight: 800;">Kategori Topik</h3>
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <button class="category-btn active" onclick="filterThreads('all', this)"><i class="fas fa-globe"></i> Semua Topik</button>
                    <button class="category-btn" onclick="filterThreads('Pemasaran', this)"><i class="fas fa-bullhorn"></i> Pemasaran</button>
                    <button class="category-btn" onclick="filterThreads('Legalitas', this)"><i class="fas fa-scale-balanced"></i> Legalitas</button>
                    <button class="category-btn" onclick="filterThreads('Modal', this)"><i class="fas fa-coins"></i> Keuangan</button>
                    <button class="category-btn" onclick="filterThreads('Operasional', this)"><i class="fas fa-box-open"></i> Operasional</button>
                </div>
            </div>

            <div class="trending-box" id="trendingList">
                <h4 style="color: #d97706; font-size: 0.95rem; margin-bottom: 15px; display:flex; align-items:center; gap:8px;">
                    <i class="fas fa-fire"></i> Topik Hangat
                </h4>
                <div style="text-align:center; font-size:0.8rem; color:#94a3b8;">Memuat...</div>
            </div>
        </aside>

        <main class="main-feed">
            
            <div id="feedView">
                <div class="feed-header">
                    <i class="fas fa-search" style="color: #94a3b8;"></i>
                    <input type="text" id="searchInput" class="search-input" placeholder="Cari topik diskusi..." onkeyup="searchThreads()">
                    <button class="btn-create" onclick="openModal()">
                        <i class="fas fa-plus"></i> <span style="display: none; @media(min-width:768px){ display:inline; }">Buat Diskusi</span>
                    </button>
                </div>

                <div id="threadList">
                    <div style="text-align: center; color: #64748b; padding: 20px;">Memuat Diskusi...</div>
                </div>
            </div>

            <div id="detailView">
                
                <div class="detail-top">
                    <button onclick="closeDetail()" style="background:none; border:none; color:var(--text-gray); cursor:pointer; margin-bottom:15px; font-weight:700; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                    
                    <span class="badge-cat bg-umum" id="detailCat">Kategori</span>
                    <h1 style="font-family: var(--font-head); font-size: 1.6rem; margin: 10px 0; color: var(--dark);" id="detailTitle">Judul Thread</h1>
                    
                    <div style="display:flex; align-items:center; gap:10px; font-size:0.85rem; color:#64748b; margin-bottom:15px;">
                        <span id="detailAuthor" style="font-weight:700; color:var(--dark);">User</span> â€¢ <span id="detailDate">Just now</span>
                    </div>

                    <div style="font-size: 1rem; line-height: 1.6; color: #334155;" id="detailBody">Isi konten...</div>
                </div>

                <div class="detail-scroll-area">
                    <h4 style="margin-bottom:15px; color:var(--dark);">Komentar (<span id="commentCount">0</span>)</h4>
                    <div id="commentsList">
                        </div>
                </div>

                <div class="detail-bottom">
                    <div class="input-group">
                        <input type="text" id="commentInput" class="input-box" placeholder="Tulis balasan...">
                        <button onclick="postComment()" class="btn-send"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <button class="fab-create" onclick="openModal()">
        <i class="fas fa-plus"></i>
    </button>

    <div id="createModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="font-family:var(--font-head); font-size: 1.5rem; color: var(--primary-dark);">Buat Diskusi Baru</h2>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color:#94a3b8;">&times;</button>
            </div>
            <form onsubmit="handlePost(event)">
                <div class="form-group">
                    <label style="font-weight:700; display:block; margin-bottom:8px;">Judul Pertanyaan</label>
                    <input type="text" id="postTitle" class="form-control" placeholder="Singkat dan jelas..." required>
                </div>
                <div class="form-group">
                    <label style="font-weight:700; display:block; margin-bottom:8px;">Kategori</label>
                    <select id="postCategory" class="form-control">
                        <option value="Umum">Umum</option>
                        <option value="Pemasaran">Pemasaran & Ads</option>
                        <option value="Legalitas">Legalitas & Izin</option>
                        <option value="Modal">Keuangan & Modal</option>
                        <option value="Operasional">Operasional</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="font-weight:700; display:block; margin-bottom:8px;">Detail Pertanyaan</label>
                    <textarea id="postContent" class="form-control" rows="5" placeholder="Ceritakan detail masalah atau pertanyaan Anda..." required></textarea>
                </div>
                <button type="submit" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer;">Posting Diskusi</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIaLzkNM0KqPVKxuMNmardLqcrr2kYTWQ",
            authDomain: "database-idbm.firebaseapp.com",
            projectId: "database-idbm",
            storageBucket: "database-idbm.firebasestorage.app",
            messagingSenderId: "1052290789133",
            appId: "1:1052290789133:web:36b513630b7a87154eca44",
            measurementId: "G-EQLBB94DY2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentThreadId = null;
        let allThreads = [];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docSnap = await getDoc(doc(db, "users_umkm", user.uid));
                if (docSnap.exists()) {
                    currentUser = {
                        uid: user.uid,
                        name: docSnap.data().nama_lengkap || "User UMKM",
                    };
                } else {
                    currentUser = { uid: user.uid, name: "User" };
                }
                loadThreads();
                loadTrending();
            } else {
                window.location.href = "login.html";
            }
        });

        // 1. LOAD ALL THREADS
        window.loadThreads = async function(category = 'all') {
            const listContainer = document.getElementById('threadList');
            try {
                let q = query(collection(db, "forum_threads"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                allThreads = [];
                
                querySnapshot.forEach((doc) => {
                    allThreads.push({ id: doc.id, ...doc.data() });
                });

                renderThreads(category);
            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<div style="text-align:center; color:#64748b;">Gagal memuat diskusi.</div>';
            }
        }

        // 2. LOAD TRENDING
        async function loadTrending() {
            const container = document.getElementById('trendingList');
            try {
                const q = query(collection(db, "forum_threads"), orderBy("likes", "desc"), limit(3));
                const snapshot = await getDocs(q);

                container.innerHTML = `<h4 style="color: #d97706; font-size: 0.95rem; margin-bottom: 15px; display:flex; align-items:center; gap:8px;"><i class="fas fa-fire"></i> Topik Hangat</h4>`;

                if (snapshot.empty) {
                    container.innerHTML += `<div style="text-align:center; font-size:0.8rem; color:#94a3b8;">Belum ada topik populer.</div>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const t = doc.data();
                    const html = `
                        <div class="trend-item" onclick="openDetail('${doc.id}')">
                            <div class="trend-title">${t.title}</div>
                            <div class="trend-stats">${t.likes || 0} Likes</div>
                        </div>`;
                    container.innerHTML += html;
                });
            } catch (e) { console.error(e); }
        }

        // 3. RENDER FUNCTION
        function renderThreads(filterCat) {
            const listContainer = document.getElementById('threadList');
            listContainer.innerHTML = "";

            let filtered = allThreads;
            if (filterCat !== 'all') {
                filtered = allThreads.filter(t => t.category === filterCat);
            }

            if (filtered.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; color:#64748b; padding:20px;">Belum ada diskusi di kategori ini.</div>';
                return;
            }

            filtered.forEach(t => {
                const date = t.timestamp ? new Date(t.timestamp.toDate()).toLocaleDateString('id-ID') : 'Baru saja';
                let badgeClass = 'bg-umum';
                if(t.category === 'Pemasaran') badgeClass = 'bg-pemasaran';
                if(t.category === 'Legalitas') badgeClass = 'bg-pajak';
                if(t.category === 'Modal') badgeClass = 'bg-izin';

                const html = `
                <div class="thread-card" onclick="openDetail('${t.id}')">
                    <div class="thread-meta">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <i class="fas fa-user-circle"></i> <b>${t.author_name}</b>
                        </div>
                        <span>${date}</span>
                    </div>
                    <div style="margin-bottom:8px;"><span class="badge-cat ${badgeClass}">${t.category}</span></div>
                    <div class="thread-title">${t.title}</div>
                    <div class="thread-preview">${t.content}</div>
                    <div class="thread-stats">
                        <div class="stat-item"><i class="far fa-comment-alt"></i> ${t.comment_count || 0}</div>
                        <div class="stat-item"><i class="far fa-thumbs-up"></i> ${t.likes || 0}</div>
                    </div>
                </div>`;
                listContainer.innerHTML += html;
            });
        }

        window.handlePost = async function(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.innerText = "Memposting...";
            btn.disabled = true;

            const title = document.getElementById('postTitle').value;
            const category = document.getElementById('postCategory').value;
            const content = document.getElementById('postContent').value;

            try {
                await addDoc(collection(db, "forum_threads"), {
                    title: title, category: category, content: content,
                    author_uid: currentUser.uid, author_name: currentUser.name,
                    timestamp: new Date(), likes: 0, comment_count: 0
                });
                closeModal(); e.target.reset(); loadThreads(); loadTrending();
                alert("Diskusi berhasil diposting!");
            } catch (e) { alert("Gagal: " + e.message); } 
            finally { btn.innerText = "Posting Diskusi"; btn.disabled = false; }
        }

        window.openDetail = async function(id) {
            currentThreadId = id;
            const thread = allThreads.find(t => t.id === id);
            if(!thread) return;

            document.getElementById('feedView').style.display = 'none';
            document.getElementById('detailView').style.display = 'flex'; // Changed to Flex
            
            // Hide mobile items
            if(window.innerWidth <= 768) {
                document.querySelector('.mobile-header').style.display = 'none';
                document.querySelector('.mobile-filter-bar').style.display = 'none';
                document.querySelector('.fab-create').style.display = 'none';
            }

            document.getElementById('detailTitle').innerText = thread.title;
            document.getElementById('detailCat').innerText = thread.category;
            document.getElementById('detailAuthor').innerText = thread.author_name;
            document.getElementById('detailDate').innerText = thread.timestamp ? new Date(thread.timestamp.toDate()).toLocaleDateString('id-ID') : '-';
            document.getElementById('detailBody').innerText = thread.content;

            loadComments(id);
        }

        window.closeDetail = function() {
            document.getElementById('feedView').style.display = 'block'; // Changed from flex to block/default
            document.getElementById('detailView').style.display = 'none';
            
            if (window.innerWidth <= 768) {
                document.querySelector('.mobile-header').style.display = 'flex';
                document.querySelector('.mobile-filter-bar').style.display = 'flex';
                document.querySelector('.fab-create').style.display = 'flex';
            }
            currentThreadId = null;
        }

        async function loadComments(threadId) {
            const list = document.getElementById('commentsList');
            list.innerHTML = "<div style='text-align:center; color:#94a3b8; padding:20px;'>Memuat komentar...</div>";
            
            const q = query(collection(db, `forum_threads/${threadId}/comments`), orderBy("timestamp", "asc"));
            const snapshot = await getDocs(q);
            
            list.innerHTML = "";
            document.getElementById('commentCount').innerText = snapshot.size;

            if(snapshot.empty) { list.innerHTML = "<p style='color:#94a3b8; text-align:center; padding:20px;'>Belum ada komentar. Jadilah yang pertama!</p>"; return; }

            snapshot.forEach(doc => {
                const c = doc.data();
                const html = `
                <div class="comment-bubble">
                    <div class="comment-header">
                        <span class="comment-author">${c.author_name}</span>
                        <span class="comment-time">${new Date(c.timestamp.toDate()).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div class="comment-text">${c.text}</div>
                </div>`;
                list.innerHTML += html;
            });
            
            // Scroll to bottom
            const scrollArea = document.querySelector('.detail-scroll-area');
            scrollArea.scrollTop = scrollArea.scrollHeight;
        }

        window.postComment = async function() {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            if(!text) return;

            try {
                await addDoc(collection(db, `forum_threads/${currentThreadId}/comments`), {
                    text: text, author_name: currentUser.name, author_uid: currentUser.uid, timestamp: new Date()
                });
                const threadRef = doc(db, "forum_threads", currentThreadId);
                await updateDoc(threadRef, { comment_count: increment(1) });
                input.value = "";
                loadComments(currentThreadId);
            } catch (e) { alert("Gagal mengirim komentar"); }
        }

        // --- UI HELPERS ---
        window.openModal = () => document.getElementById('createModal').style.display = 'flex';
        window.closeModal = () => document.getElementById('createModal').style.display = 'none';
        
        window.filterThreads = (cat, btn) => {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); renderThreads(cat);
        }

        window.filterThreadsMobile = (cat, btn) => {
            document.querySelectorAll('.mobile-chip').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); renderThreads(cat);
        }

        window.searchThreads = () => {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allThreads.filter(t => t.title.toLowerCase().includes(keyword) || t.content.toLowerCase().includes(keyword));
            // ... (Logic render simplified)
            renderThreads('all'); 
        }
    </script>
</body>
</html>