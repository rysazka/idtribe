<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Detail Pengajuan - ID-TRIBE</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

    <style>
        :root {
            --primary: #059669; --primary-dark: #047857; --primary-light: #d1fae5;
            --accent: #f59e0b; --dark: #0f172a; --text-gray: #64748b; --border: #e2e8f0;
            --font-head: 'Outfit', sans-serif; --font-body: 'Plus Jakarta Sans', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background: #f8fafc; color: var(--dark); padding-bottom: 90px; }

        /* HEADER */
        .top-nav {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            background: white; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 5%; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .nav-back { text-decoration: none; color: var(--text-gray); font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .nav-back:hover { color: var(--primary); transform: translateX(-3px); }
        .brand { font-family: var(--font-head); font-weight: 800; font-size: 1.2rem; }

        /* LAYOUT */
        .container { max-width: 1100px; margin: 90px auto 30px auto; padding: 0 20px; display: grid; grid-template-columns: 320px 1fr; gap: 25px; }

        /* LEFT SIDEBAR (SENDER PROFILE) */
        .profile-card { background: white; border-radius: 16px; padding: 25px; border: 1px solid var(--border); text-align: center; position: sticky; top: 90px; }
        .p-avatar { width: 80px; height: 80px; background: var(--primary-light); color: var(--primary-dark); font-size: 2rem; font-weight: 800; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px auto; }
        .p-name { font-family: var(--font-head); font-weight: 700; font-size: 1.2rem; margin-bottom: 5px; }
        .p-meta { font-size: 0.85rem; color: var(--text-gray); margin-bottom: 20px; }
        
        .trust-score { background: #f0fdf4; padding: 10px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #bbf7d0; }
        .score-val { font-weight: 800; color: var(--primary); font-size: 1.1rem; }
        .score-lbl { font-size: 0.75rem; color: var(--text-gray); }

        .info-list { text-align: left; list-style: none; font-size: 0.9rem; }
        .info-list li { margin-bottom: 12px; display: flex; align-items: center; gap: 10px; color: var(--dark); }
        .info-list i { color: var(--text-gray); width: 20px; }

        /* RIGHT CONTENT (PROPOSAL) */
        .main-card { background: white; border-radius: 16px; padding: 30px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.02); min-height: 400px; }
        
        .req-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .req-type { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-gray); font-weight: 700; margin-bottom: 5px; display: block; }
        .req-title { font-family: var(--font-head); font-size: 1.5rem; font-weight: 800; color: var(--dark); line-height: 1.3; }
        
        .status-badge { padding: 6px 15px; border-radius: 30px; font-weight: 700; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 6px; }
        .st-pending { background: #fef3c7; color: #d97706; }
        .st-accepted { background: #dcfce7; color: #166534; }
        .st-rejected { background: #fee2e2; color: #991b1b; }

        /* METRICS */
        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .metric-box { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .metric-lbl { font-size: 0.75rem; color: var(--text-gray); font-weight: 600; display: block; margin-bottom: 5px; text-transform: uppercase; }
        .metric-val { font-weight: 700; color: var(--dark); font-size: 1rem; }

        .section-title { font-weight: 700; font-size: 1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; color: var(--dark); }
        .proposal-text { line-height: 1.8; color: #475569; margin-bottom: 30px; white-space: pre-line; }

        /* ACTION BAR (STICKY BOTTOM) */
        .action-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; background: white; 
            padding: 15px 30px; border-top: 1px solid var(--border); z-index: 900;
            display: flex; justify-content: flex-end; gap: 15px; box-shadow: 0 -5px 20px rgba(0,0,0,0.03);
        }
        .btn-act { padding: 12px 25px; border-radius: 10px; font-weight: 700; cursor: pointer; border: none; font-size: 0.95rem; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        
        .btn-chat { background: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; }
        .btn-chat:hover { background: #3b82f6; color: white; }
        
        .btn-reject { background: white; color: #ef4444; border: 1px solid #fee2e2; }
        .btn-reject:hover { background: #fee2e2; }
        
        .btn-accept { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(5,150,105,0.2); }
        .btn-accept:hover { background: var(--primary-dark); transform: translateY(-2px); }

        .btn-terminate { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .btn-terminate:hover { background: #dc2626; color: white; border-color: #dc2626; }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; margin-top: 80px; }
            .profile-card { position: relative; top: 0; }
            .action-bar { justify-content: center; flex-wrap: wrap; }
            .btn-act { flex: 1; justify-content: center; }
        }
    </style>
</head>
<body>

    <nav class="top-nav">
        <a href="partnership.html" class="nav-back"><i class="fas fa-arrow-left"></i> Kembali</a>
        <div class="brand">ID<span>TRIBE</span></div>
        <div style="width: 80px;"></div>
    </nav>

    <div class="container">
        
        <aside>
            <div class="profile-card" id="partnerCard">
                <div style="padding: 40px; color: gray;">
                    <i class="fas fa-circle-notch fa-spin"></i> Loading Profil...
                </div>
            </div>
        </aside>

        <main>
            <div class="main-card" id="proposalCard">
                <div style="text-align:center; padding:50px; color:gray;">
                    <i class="fas fa-circle-notch fa-spin"></i> Memuat Data Pengajuan...
                </div>
            </div>
        </main>

    </div>

    <div class="action-bar" id="actionBar">
        </div>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIaLzkNM0KqPVKxuMNmardLqcrr2kYTWQ",
            authDomain: "database-idbm.firebaseapp.com",
            projectId: "database-idbm",
            storageBucket: "database-idbm.firebasestorage.app",
            messagingSenderId: "1052290789133",
            appId: "1:1052290789133:web:36b513630b7a87154eca44",
            measurementId: "G-EQLBB94DY2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let requestData = null;
        const urlParams = new URLSearchParams(window.location.search);
        const reqId = urlParams.get('id');

        // 1. AUTH CHECK
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                if (!reqId) {
                    showError("ID tidak ditemukan.");
                    return;
                }
                loadRequestDetail(reqId);
            } else {
                window.location.href = "login.html";
            }
        });

        // 2. LOAD DETAIL
        async function loadRequestDetail(id) {
            try {
                const docRef = doc(db, "partnership_requests", id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    requestData = docSnap.data();
                    requestData.id = docSnap.id;
                    
                    let partnerId;
                    let direction;

                    // LOGIKA PENENTUAN PARTNER (PENTING!)
                    if (requestData.senderId === currentUser.uid) {
                        // Saya Pengirim -> Partner adalah Target
                        partnerId = requestData.targetId; 
                        direction = 'out';
                    } else {
                        // Saya Penerima -> Partner adalah Pengirim
                        partnerId = requestData.senderId; 
                        direction = 'in';
                    }

                    renderProposal(requestData, direction, partnerId);
                    loadPartnerProfile(partnerId);

                } else {
                    showError("Data tidak ditemukan.");
                }
            } catch (error) {
                console.error(error);
                showError("Error koneksi.");
            }
        }

        // 3. LOAD PROFILE
        async function loadPartnerProfile(uid) {
            try {
                const userRef = doc(db, "users_umkm", uid);
                const userSnap = await getDoc(userRef);
                
                let pName = "User", pLoc = "-", pCat = "-", pInitial = "U";

                if (userSnap.exists()) {
                    const d = userSnap.data();
                    pName = d.nama_usaha || d.nama_lengkap;
                    pLoc = d.lokasi || "Indonesia";
                    pCat = d.kategori || "Umum";
                    pInitial = pName.charAt(0).toUpperCase();
                }

                document.getElementById('partnerCard').innerHTML = `
                    <div class="p-avatar">${pInitial}</div>
                    <div class="p-name">${pName}</div>
                    <div class="p-meta">${pCat} • ${pLoc}</div>
                    <div class="trust-score"><div class="score-val">Verified</div><div class="score-lbl">Status Akun</div></div>
                    <ul class="info-list">
                        <li><i class="fas fa-map-marker-alt"></i> ${pLoc}</li>
                        <li><i class="fas fa-briefcase"></i> ${pCat}</li>
                    </ul>
                `;
            } catch (e) { console.error(e); }
        }

        // 4. RENDER PROPOSAL UI
        function renderProposal(data, direction, partnerId) {
            let badge = '';
            if(data.status === 'accepted') badge = `<div class="status-badge st-accepted">Aktif</div>`;
            else if(data.status === 'pending') badge = `<div class="status-badge st-pending">Review</div>`;
            else badge = `<div class="status-badge st-rejected">Batal/Tolak</div>`;

            let dateStr = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleDateString() : "Baru Saja";

            document.getElementById('proposalCard').innerHTML = `
                <div class="req-header">
                    <div><span class="req-type">${direction==='in'?'Masuk':'Keluar'} • ${dateStr}</span><div class="req-title">${data.title}</div></div>
                    ${badge}
                </div>
                <div class="metrics-grid">
                    <div class="metric-box"><span class="metric-lbl">Tipe</span><div class="metric-val">Partnership</div></div>
                    <div class="metric-box"><span class="metric-lbl">Status</span><div class="metric-val" style="text-transform:capitalize;">${data.status}</div></div>
                    <div class="metric-box"><span class="metric-lbl">ID</span><div class="metric-val">#${data.id.substr(0,6)}</div></div>
                </div>
                <div class="section-title">Isi Proposal</div>
                <div class="proposal-text">${data.desc}</div>
            `;

            // Panggil Render Buttons dengan partnerId yang BENAR
            let partnerName = direction === 'in' ? data.senderName : data.targetName;
            renderButtons(data.status, direction, partnerId, partnerName);
        }

        // 5. RENDER BUTTONS (PERBAIKAN UTAMA DI SINI)
        function renderButtons(status, direction, partnerId, partnerName) {
            const actionBar = document.getElementById('actionBar');
            let buttons = '';

            // FIX: Masukkan partnerId ke dalam fungsi openChat
            const btnChat = `<button class="btn-act btn-chat" onclick="openChat('${partnerId}', '${partnerName}')"><i class="fas fa-comment-dots"></i> Chat</button>`;

            if (status === 'pending') {
                if (direction === 'in') {
                    buttons = `
                        <button class="btn-act btn-reject" onclick="updateStatus('rejected')">Tolak</button>
                        ${btnChat}
                        <button class="btn-act btn-accept" onclick="updateStatus('accepted')">Terima</button>
                    `;
                } else {
                    buttons = `<button class="btn-act btn-reject" onclick="updateStatus('canceled')">Batalkan</button> ${btnChat}`;
                }
            } else if (status === 'accepted') {
                buttons = `<button class="btn-act btn-terminate" onclick="updateStatus('terminated')">Hentikan</button> ${btnChat}`;
            } else {
                buttons = btnChat;
            }
            actionBar.innerHTML = buttons;
        }

        // 6. ACTIONS
        window.updateStatus = async (newStatus) => {
            Swal.fire({
                title: 'Konfirmasi', text: 'Apakah Anda yakin?', icon: 'question',
                showCancelButton: true, confirmButtonText: 'Ya'
            }).then(async (res) => {
                if (res.isConfirmed) {
                    try {
                        await updateDoc(doc(db, "partnership_requests", requestData.id), {
                            status: newStatus, updatedAt: new Date()
                        });
                        location.reload();
                    } catch(e) { Swal.fire('Error', e.message, 'error'); }
                }
            });
        }

        // FIX: Fungsi Open Chat menerima UID dan Nama
        window.openChat = (uid, name) => {
            if(!uid) { Swal.fire('Error', 'ID Partner hilang.', 'error'); return; }
            // Redirect dengan membawa partnerId
            window.location.href = `chat-room-partnership.html?partnerId=${uid}&partner=${encodeURIComponent(name)}`;
        }

        function showError(msg) {
            document.querySelector('.container').innerHTML = `<div style="padding:50px; text-align:center;">${msg} <br> <a href="partnership.html">Kembali</a></div>`;
            document.getElementById('actionBar').style.display = 'none';
        }
    </script>
</body>
</html>