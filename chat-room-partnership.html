<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat Room - ID-TRIBE</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

    <style>
        :root {
            --primary: #059669; --primary-dark: #047857; --primary-light: #d1fae5;
            --dark: #0f172a; --text-gray: #64748b; --border: #e2e8f0; --bg-chat: #f0fdf4;
            --font-head: 'Outfit', sans-serif; --font-body: 'Plus Jakarta Sans', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background: var(--bg-chat); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .chat-header {
            background: white; padding: 15px 20px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); z-index: 100;
        }
        .back-btn { color: var(--text-gray); font-size: 1.2rem; cursor: pointer; transition: 0.2s; text-decoration: none;}
        .back-btn:hover { color: var(--primary); }
        
        .partner-info { flex: 1; display: flex; align-items: center; gap: 10px; }
        .p-avatar { width: 40px; height: 40px; background: var(--primary-light); color: var(--primary-dark); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1rem; }
        .p-name { font-family: var(--font-head); font-weight: 700; font-size: 1rem; color: var(--dark); line-height: 1.2; }
        .p-status { font-size: 0.75rem; color: var(--primary); display: flex; align-items: center; gap: 4px; }
        .p-status::before { content: ''; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; display: inline-block; }

        .header-actions { display: flex; gap: 15px; color: var(--primary); font-size: 1.1rem; cursor: pointer; }

        /* CHAT AREA */
        .chat-container {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px;
            scroll-behavior: smooth;
        }

        .system-msg { text-align: center; font-size: 0.75rem; color: var(--text-gray); background: #fef3c7; padding: 8px 15px; border-radius: 20px; align-self: center; max-width: 90%; border: 1px solid #fcd34d; margin-bottom: 15px; }

        .msg-row { display: flex; width: 100%; margin-bottom: 5px; animation: fadeIn 0.3s ease; }
        .msg-row.me { justify-content: flex-end; }
        .msg-row.partner { justify-content: flex-start; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .bubble {
            max-width: 75%; padding: 12px 16px; border-radius: 12px; position: relative; font-size: 0.95rem; line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); word-wrap: break-word;
        }
        .msg-row.partner .bubble { background: white; color: var(--dark); border-radius: 0 12px 12px 12px; }
        .msg-row.me .bubble { background: var(--primary); color: white; border-radius: 12px 0 12px 12px; }

        .msg-time { font-size: 0.65rem; margin-top: 4px; text-align: right; opacity: 0.7; display: flex; align-items: center; justify-content: flex-end; gap: 4px; }
        .msg-row.me .msg-time { color: #d1fae5; }
        .msg-row.partner .msg-time { color: #94a3b8; }

        /* INPUT AREA */
        .input-area {
            background: white; padding: 15px; border-top: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px;
        }
        .attach-btn { color: var(--text-gray); font-size: 1.3rem; cursor: pointer; padding: 5px; transition: 0.2s; }
        .attach-btn:hover { color: var(--primary); transform: rotate(90deg); }

        .chat-input {
            flex: 1; border: none; background: #f1f5f9; padding: 12px 20px; border-radius: 25px;
            font-family: var(--font-body); font-size: 0.95rem; outline: none; transition: 0.2s;
        }
        .chat-input:focus { background: white; box-shadow: 0 0 0 2px var(--primary-light); }

        .send-btn {
            background: var(--primary); color: white; border: none; width: 45px; height: 45px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; cursor: pointer; transition: 0.2s;
        }
        .send-btn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }
        .send-btn:hover:not(:disabled) { background: var(--primary-dark); transform: scale(1.1); }

    </style>
</head>
<body>

    <div class="chat-header">
        <a href="#" onclick="history.back()" class="back-btn"><i class="fas fa-arrow-left"></i></a>
        <div class="partner-info">
            <div class="p-avatar" id="cAvatar">...</div>
            <div>
                <div class="p-name" id="cName">Memuat...</div>
                <div class="p-status">Online</div>
            </div>
        </div>
        <div class="header-actions">
            <i class="fas fa-phone-alt"></i>
            <i class="fas fa-ellipsis-v"></i>
        </div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="system-msg">
            <i class="fas fa-lock"></i> Pesan ini terenkripsi end-to-end. Negosiasi aman dijamin oleh ID-TRIBE.
        </div>
        </div>

    <form class="input-area" onsubmit="sendMessage(event)">
        <div class="attach-btn"><i class="fas fa-paperclip"></i></div>
        <input type="text" id="msgInput" class="chat-input" placeholder="Tulis pesan..." autocomplete="off">
        <button type="submit" class="send-btn" id="btnSend"><i class="fas fa-paper-plane"></i></button>
    </form>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBIaLzkNM0KqPVKxuMNmardLqcrr2kYTWQ",
            authDomain: "database-idbm.firebaseapp.com",
            projectId: "database-idbm",
            storageBucket: "database-idbm.firebasestorage.app",
            messagingSenderId: "1052290789133",
            appId: "1:1052290789133:web:36b513630b7a87154eca44",
            measurementId: "G-EQLBB94DY2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let roomId = null;
        let partnerName = "Partner";

        // 1. INIT & AUTH CHECK
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                initChat();
            } else {
                window.location.href = "login.html";
            }
        });

        // 2. SETUP CHAT ROOM
        async function initChat() {
            const urlParams = new URLSearchParams(window.location.search);
            const partnerId = urlParams.get('partnerId'); 
            const pNameRaw = urlParams.get('partner'); 

            if (!partnerId) {
                // Jika tidak ada ID, kembali
                alert("Error: Partner ID tidak ditemukan.");
                history.back();
                return;
            }

            // UI Header
            if (pNameRaw) {
                partnerName = decodeURIComponent(pNameRaw);
                document.getElementById('cName').innerText = partnerName;
                document.getElementById('cAvatar').innerText = partnerName.charAt(0).toUpperCase();
            }

            // ROOM ID GENERATION (PENTING!)
            // Mengurutkan UID agar A->B dan B->A menghasilkan Room ID yang sama
            const ids = [currentUser.uid, partnerId].sort();
            roomId = ids.join("_");

            console.log("Chat Room ID:", roomId);
            
            // Mulai Listener Pesan
            loadMessages();
        }

        // 3. LISTEN MESSAGES (OPTIMIZED: DOC CHANGES)
        function loadMessages() {
            const container = document.getElementById('chatContainer');
            const messagesRef = collection(db, "chats", roomId, "messages");
            const q = query(messagesRef, orderBy("createdAt", "asc"));

            // onSnapshot Realtime
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        // Hanya render pesan baru yang ditambahkan (append)
                        const msg = change.doc.data();
                        renderMessage(msg);
                    }
                });
                
                // Auto Scroll ke bawah setiap ada update
                scrollToBottom();
            });
        }

        // 4. RENDER MESSAGE BUBBLE
        function renderMessage(msg) {
            const container = document.getElementById('chatContainer');
            const isMe = msg.senderId === currentUser.uid;
            
            // Format Time (Handle Timestamp Firebase)
            let timeStr = "...";
            if (msg.createdAt) {
                const date = msg.createdAt.toDate ? msg.createdAt.toDate() : new Date(msg.createdAt);
                timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            }

            const checkIcon = isMe ? '<i class="fas fa-check-double"></i>' : '';

            const html = `
            <div class="msg-row ${isMe ? 'me' : 'partner'}">
                <div class="bubble">
                    ${msg.text}
                    <div class="msg-time">${timeStr} ${checkIcon}</div>
                </div>
            </div>`;

            container.insertAdjacentHTML('beforeend', html);
        }

        function scrollToBottom() {
            const container = document.getElementById('chatContainer');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // 5. SEND MESSAGE LOGIC
        window.sendMessage = async (e) => {
            e.preventDefault();
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            const btn = document.getElementById('btnSend');

            if (!text || !roomId) return;

            btn.disabled = true; // Cegah double submit

            try {
                // Simpan ke Firestore
                await addDoc(collection(db, "chats", roomId, "messages"), {
                    text: text,
                    senderId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    isRead: false
                });

                input.value = ""; // Clear input
                input.focus();
            } catch (error) {
                console.error("Error sending message:", error);
                alert("Gagal mengirim pesan. Periksa koneksi.");
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>