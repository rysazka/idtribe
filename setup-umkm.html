<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Identitas UMKM - ID-TRIBE</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"></script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --forest-green: #2E5C48;
            --forest-green-dark: #1e3d2f;
            --golden-orange: #F2994A;
            --golden-orange-dark: #e88a38;
            --text-dark: #1a1a1a;
            --text-muted: #64748b;
            
            /* Glass Effect */
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-blur: blur(20px);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--forest-green);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 40px 20px;
        }

        /* --- BACKGROUND --- */
        .bg-image {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.unsplash.com/photo-1619338098121-5925681fc9ab?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=1920');
            background-size: cover; background-position: center;
            z-index: -2;
        }
        .bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(46, 92, 72, 0.9), rgba(46, 92, 72, 0.8));
            z-index: -1;
        }

        /* --- CONTAINER --- */
        .setup-container { width: 100%; max-width: 800px; position: relative; z-index: 10; }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--glass-shadow);
        }

        .header-title { text-align: center; margin-bottom: 40px; }
        .header-title h2 { font-size: 1.8rem; color: var(--forest-green); font-weight: 700; margin-bottom: 5px; }
        .header-title p { color: var(--text-muted); }

        /* --- WIZARD PROGRESS --- */
        .wizard-progress {
            display: flex; justify-content: space-between; margin-bottom: 40px; position: relative;
            max-width: 600px; margin-left: auto; margin-right: auto;
        }
        .wizard-progress::before {
            content: ''; position: absolute; top: 15px; left: 0; width: 100%; height: 3px;
            background: #e2e8f0; z-index: 0;
        }
        .step-indicator {
            position: relative; z-index: 1; text-align: center; width: 80px;
        }
        .step-circle {
            width: 34px; height: 34px; background: white; border: 2px solid #cbd5e1;
            border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; font-weight: bold; color: var(--text-muted); transition: all 0.3s;
        }
        .step-label { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; }
        
        /* Active & Completed States */
        .step-indicator.active .step-circle { border-color: var(--forest-green); background: var(--forest-green); color: white; box-shadow: 0 0 0 4px rgba(46, 92, 72, 0.2); }
        .step-indicator.active .step-label { color: var(--forest-green); }
        
        .step-indicator.completed .step-circle { border-color: var(--golden-orange); background: var(--golden-orange); color: white; }
        .step-indicator.completed .step-label { color: var(--golden-orange); }

        /* --- FORMS --- */
        .step-content { display: none; animation: slideUp 0.5s ease; }
        .step-content.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 20px; }
        .full-width { grid-column: span 2; }
        
        .form-label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 600; color: var(--text-dark); }
        .form-input, select.form-input {
            width: 100%; padding: 12px 16px; background: white;
            border: 2px solid #e2e8f0; border-radius: 12px;
            color: var(--text-dark); font-family: inherit; font-size: 1rem;
            transition: all 0.3s;
        }
        .form-input:focus { outline: none; border-color: var(--forest-green); box-shadow: 0 0 0 4px rgba(46, 92, 72, 0.1); }
        select.form-input { cursor: pointer; }

        /* --- CHECKBOX TAGS --- */
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .checkbox-label {
            display: flex; align-items: center; gap: 8px;
            background: white; padding: 10px 20px;
            border-radius: 50px; cursor: pointer; border: 2px solid #e2e8f0; transition: all 0.3s;
            color: var(--text-muted); font-weight: 500; font-size: 0.9rem;
        }
        .checkbox-label:hover { border-color: var(--golden-orange); }
        .checkbox-label input { display: none; } /* Hide default checkbox */
        
        /* Checked State */
        .checkbox-label input:checked + span { color: white; }
        .checkbox-label:has(input:checked) {
            background: var(--forest-green); border-color: var(--forest-green); color: white;
        }

        /* --- BUTTONS --- */
        .btn-group { display: flex; justify-content: space-between; margin-top: 40px; gap: 15px; border-top: 1px solid #e2e8f0; padding-top: 25px; }
        .btn {
            padding: 12px 28px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; font-family: inherit; transition: all 0.2s; font-size: 1rem;
        }
        .btn-prev { background: #f1f5f9; color: var(--text-muted); }
        .btn-prev:hover { background: #e2e8f0; color: var(--text-dark); }
        
        .btn-next { background: var(--golden-orange); color: white; flex: 1; max-width: 200px; margin-left: auto; box-shadow: 0 4px 15px rgba(242, 153, 74, 0.4); }
        .btn-next:hover { background: var(--golden-orange-dark); transform: translateY(-2px); }

        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            .wizard-progress::before { top: 12px; }
            .step-label { display: none; } /* Hide text on mobile */
            .setup-container { padding: 0 10px; }
            .glass-card { padding: 25px; }
        }
    </style>
</head>
<body>

    <div class="bg-image"></div>
    <div class="bg-overlay"></div>

    <div class="setup-container">
        <div class="glass-card">
            <div class="header-title">
                <h2>Lengkapi Identitas UMKM</h2>
                <p>Data yang lengkap meningkatkan kepercayaan investor & pembeli.</p>
            </div>

            <div class="wizard-progress">
                <div class="step-indicator active" id="ind-1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Profil</div>
                </div>
                <div class="step-indicator" id="ind-2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Ops</div>
                </div>
                <div class="step-indicator" id="ind-3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Legal</div>
                </div>
                <div class="step-indicator" id="ind-4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Digital</div>
                </div>
            </div>

            <form id="setupForm" onsubmit="handleFinalSubmit(event)">
                
                <div id="step-1" class="step-content active">
                    <h3 style="margin-bottom: 20px; color: var(--forest-green);">1. Profil Dasar Bisnis</h3>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">Nama Brand / Usaha</label>
                            <input type="text" id="nama_brand" class="form-input" required placeholder="Nama brand yang dikenal konsumen">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kategori / Sektor</label>
                            <select id="kategori" class="form-input" required>
                                <option value="kuliner">Kuliner</option>
                                <option value="fashion">Fashion</option>
                                <option value="craft">Kerajinan</option>
                                <option value="jasa">Jasa</option>
                                <option value="agri">Agribisnis</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tahun Berdiri</label>
                            <input type="number" id="tahun_berdiri" class="form-input" placeholder="Contoh: 2020">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Lokasi Usaha (Kota/Kab)</label>
                            <input type="text" id="lokasi" class="form-input" required placeholder="Contoh: Bandung, Jawa Barat">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-prev" disabled style="opacity: 0.5;">Kembali</button>
                        <button type="button" class="btn btn-next" onclick="nextStep(2)">Lanjut &rarr;</button>
                    </div>
                </div>

                <div id="step-2" class="step-content">
                    <h3 style="margin-bottom: 20px; color: var(--forest-green);">2. Operasional & Kapasitas</h3>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">Jumlah Karyawan / Tim</label>
                            <select id="karyawan" class="form-input">
                                <option value="sendiri">Dikelola Sendiri (Solo)</option>
                                <option value="keluarga">Dibantu Keluarga/Teman</option>
                                <option value="kecil">Tim Kecil (1-5 Orang)</option>
                                <option value="profesional">Tim Profesional (>5 Orang)</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Kapasitas Produksi (Per Bulan)</label>
                            <input type="text" id="kapasitas" class="form-input" placeholder="Contoh: 1000 pcs / 500 porsi">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Model Bisnis</label>
                            <select id="model_bisnis" class="form-input">
                                <option value="b2c">B2C (Langsung ke Konsumen)</option>
                                <option value="b2b">B2B (Ke Bisnis Lain/Kantor)</option>
                                <option value="reseller">Reseller / Dropship</option>
                                <option value="hybrid">Campuran (B2B & B2C)</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-prev" onclick="prevStep(1)">&larr; Kembali</button>
                        <button type="button" class="btn btn-next" onclick="nextStep(3)">Lanjut &rarr;</button>
                    </div>
                </div>

                <div id="step-3" class="step-content">
                    <h3 style="margin-bottom: 20px; color: var(--forest-green);">3. Legalitas & Sertifikasi</h3>
                    
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">Nomor NIB</label>
                            <input type="text" id="nib" class="form-input" placeholder="Nomor Induk Berusaha">
                        </div>
                        
                        <div class="form-group full-width">
                            <label class="form-label">Upload Bukti NIB (PDF/Gambar)</label>
                            <input type="file" id="nib_file" class="form-input" accept=".pdf,image/*">
                            <small style="color:var(--text-muted); font-size:0.8rem;">Maksimal 2MB.</small>
                        </div>

                        <div class="form-group full-width">
                            <label class="form-label">Sertifikasi Halal</label>
                            <select id="halal" class="form-input">
                                <option value="belum">Belum Ada</option>
                                <option value="proses">Sedang Proses</option>
                                <option value="ada">Sudah Ada</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Izin Edar (PIRT / BPOM)</label>
                            <input type="text" id="izin_edar" class="form-input" placeholder="Nomor PIRT/MD (Khusus F&B)">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-prev" onclick="prevStep(2)">&larr; Kembali</button>
                        <button type="button" class="btn btn-next" onclick="nextStep(4)">Lanjut &rarr;</button>
                    </div>
                </div>

                <div id="step-4" class="step-content">
                    <h3 style="margin-bottom: 20px; color: var(--forest-green);">4. Data Digital & Penjualan</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Kanal Penjualan (Pilih yang aktif)</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label"><input type="checkbox" value="Shopee" name="kanal"> <span>Shopee</span></label>
                            <label class="checkbox-label"><input type="checkbox" value="Tokopedia" name="kanal"> <span>Tokopedia</span></label>
                            <label class="checkbox-label"><input type="checkbox" value="Tiktok" name="kanal"> <span>TikTok Shop</span></label>
                            <label class="checkbox-label"><input type="checkbox" value="Instagram" name="kanal"> <span>Instagram</span></label>
                            <label class="checkbox-label"><input type="checkbox" value="Offline" name="kanal"> <span>Toko Fisik</span></label>
                            <label class="checkbox-label"><input type="checkbox" value="WhatsApp" name="kanal"> <span>WhatsApp</span></label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Range Omzet Bulanan</label>
                        <select id="omzet" class="form-input" required>
                            <option value="mikro_bawah">&lt; 5 Juta</option>
                            <option value="mikro_atas">5 - 10 Juta</option>
                            <option value="kecil_bawah">10 - 50 Juta</option>
                            <option value="kecil_atas">50 - 300 Juta</option>
                            <option value="menengah">&gt; 300 Juta</option>
                        </select>
                        <small style="color: var(--text-muted); font-size: 0.8rem;">Data bersifat rahasia untuk matching investor.</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Media Sosial Utama (Username)</label>
                        <input type="text" id="sosmed" class="form-input" placeholder="Contoh: @keripikjuara (IG/TikTok)">
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-prev" onclick="prevStep(3)">&larr; Kembali</button>
                        <button type="submit" class="btn btn-next" style="background: var(--forest-green);">Simpan & Selesai ✓</button>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBIaLzkNM0KqPVKxuMNmardLqcrr2kYTWQ",
            authDomain: "database-idbm.firebaseapp.com",
            projectId: "database-idbm",
            storageBucket: "database-idbm.firebasestorage.app",
            messagingSenderId: "1052290789133",
            appId: "1:1052290789133:web:36b513630b7a87154eca44",
            measurementId: "G-EQLBB94DY2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        let currentUser = null;

        // Cek Login
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("User terdeteksi:", user.uid);
            } else {
                window.location.href = 'login.html';
            }
        });

        // NAVIGASI STEP
        window.nextStep = function(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            
            // Update Indikator
            for(let i=1; i<=step; i++) {
                document.getElementById(`ind-${i}`).classList.add('active');
                if(i < step) document.getElementById(`ind-${i}`).classList.add('completed');
            }
        }

        window.prevStep = function(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            
            document.getElementById(`ind-${step+1}`).classList.remove('active');
            document.getElementById(`ind-${step}`).classList.remove('completed');
        }

        // SUBMIT DATA (UPDATED WITH FILE UPLOAD)
        window.handleFinalSubmit = async function(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.innerText = "Mengupload File...";
            btn.disabled = true;

            try {
                // 1. Upload File NIB (Jika ada)
                const nibFile = document.getElementById('nib_file').files[0];
                let nibUrl = "";

                if (nibFile) {
                    if (nibFile.size > 2 * 1024 * 1024) { throw new Error("Ukuran file NIB maksimal 2MB"); }
                    
                    const storageRef = ref(storage, `nib_files/${currentUser.uid}_${nibFile.name}`);
                    await uploadBytes(storageRef, nibFile);
                    nibUrl = await getDownloadURL(storageRef);
                }

                btn.innerText = "Menyimpan Data...";

                // 2. Ambil Checkbox
                let kanalJual = [];
                document.querySelectorAll('input[name="kanal"]:checked').forEach((checkbox) => {
                    kanalJual.push(checkbox.value);
                });

                // 3. Data Object
                const umkmData = {
                    brand: document.getElementById('nama_brand').value,
                    kategori: document.getElementById('kategori').value,
                    tahun_berdiri: document.getElementById('tahun_berdiri').value,
                    lokasi: document.getElementById('lokasi').value,
                    
                    jumlah_karyawan: document.getElementById('karyawan').value,
                    kapasitas_produksi: document.getElementById('kapasitas').value,
                    model_bisnis: document.getElementById('model_bisnis').value,
                    
                    nib: document.getElementById('nib').value,
                    nib_file_url: nibUrl, // Simpan URL file
                    status_halal: document.getElementById('halal').value,
                    izin_edar: document.getElementById('izin_edar').value,
                    
                    kanal_penjualan: kanalJual,
                    range_omzet: document.getElementById('omzet').value,
                    sosmed: document.getElementById('sosmed').value,
                    
                    status_setup: "completed",
                    last_updated: new Date()
                };

                // 4. Update Firestore
                await updateDoc(doc(db, "users_umkm", currentUser.uid), umkmData);
                
                alert("Setup Identitas Berhasil!");
                window.location.href = "business-health.html";

            } catch (error) {
                console.error("Error:", error);
                alert("Gagal menyimpan: " + error.message);
                btn.innerText = "Simpan & Selesai ✓";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>