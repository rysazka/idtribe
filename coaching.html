<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pilih Layanan Coaching - ID-TRIBE</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* (CSS SAMA SEPERTI SEBELUMNYA) */
        :root { --primary: #059669; --primary-dark: #047857; --primary-light: #d1fae5; --accent: #f59e0b; --dark: #0f172a; --text-gray: #64748b; --glass-bg: rgba(255, 255, 255, 0.9); --glass-border: 1px solid rgba(255, 255, 255, 0.6); --glass-shadow: 0 10px 40px rgba(0, 0, 0, 0.05); --font-head: 'Outfit', sans-serif; --font-body: 'Plus Jakarta Sans', sans-serif; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-body); background-color: #f0fdf4; color: var(--dark); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; background-image: radial-gradient(at 0% 0%, hsla(152,100%,93%,1) 0, transparent 50%), radial-gradient(at 100% 100%, hsla(43,100%,93%,1) 0, transparent 50%); }
        .bg-shapes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: float 10s infinite alternate; }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: var(--primary-light); }
        .blob-2 { bottom: 10%; right: -5%; width: 400px; height: 400px; background: #fef3c7; animation-delay: -4s; }
        @keyframes float { 0% { transform: translateY(0); } 100% { transform: translateY(30px); } }
        .navbar { padding: 20px 5%; display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 10; }
        .nav-back { text-decoration: none; color: var(--dark); font-weight: 700; display: flex; align-items: center; gap: 8px; transition: 0.3s; background: white; padding: 8px 20px; border-radius: 50px; border: 1px solid #e2e8f0; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .nav-back:hover { transform: translateX(-5px); border-color: var(--primary); color: var(--primary); }
        .main-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; position: relative; z-index: 10; }
        .header-text h1 { font-family: var(--font-head); font-size: 2.5rem; font-weight: 800; color: var(--dark); margin-bottom: 10px; }
        .header-text p { color: var(--text-gray); font-size: 1.1rem; max-width: 600px; margin: 0 auto 50px; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 900px; width: 100%; }
        .option-card { background: var(--glass-bg); backdrop-filter: blur(16px); border: var(--glass-border); border-radius: 30px; padding: 50px 30px; text-decoration: none; color: var(--dark); box-shadow: var(--glass-shadow); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; align-items: center; position: relative; overflow: hidden; cursor: pointer; }
        .option-card:hover { transform: translateY(-10px); border-color: var(--primary); box-shadow: 0 20px 50px rgba(5, 150, 105, 0.15); }
        .icon-circle { width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; margin-bottom: 25px; transition: 0.3s; position: relative; z-index: 2; }
        .style-live .icon-circle { background: #fee2e2; color: #ef4444; }
        .style-live:hover .icon-circle { background: #ef4444; color: white; box-shadow: 0 0 30px rgba(239, 68, 68, 0.4); }
        .style-consult .icon-circle { background: #ecfdf5; color: var(--primary); }
        .style-consult:hover .icon-circle { background: var(--primary); color: white; box-shadow: 0 0 30px rgba(5, 150, 105, 0.4); }
        .card-title { font-family: var(--font-head); font-size: 1.5rem; font-weight: 800; margin-bottom: 10px; }
        .card-desc { font-size: 0.95rem; color: var(--text-gray); line-height: 1.6; }
        .badge-live { position: absolute; top: 20px; right: 20px; background: #ef4444; color: white; padding: 5px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 5px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        @media (max-width: 768px) { .options-grid { grid-template-columns: 1fr; max-width: 400px; } .header-text h1 { font-size: 2rem; } .option-card { padding: 40px 25px; flex-direction: row; text-align: left; align-items: center; gap: 20px; } .icon-circle { width: 70px; height: 70px; font-size: 1.8rem; margin-bottom: 0; flex-shrink: 0; } .badge-live { top: 10px; right: 10px; font-size: 0.65rem; padding: 3px 8px; } }
    </style>
</head>
<body>

    <div class="bg-shapes">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <div class="navbar">
        <a href="training-hub.html" class="nav-back">
            <i class="fas fa-arrow-left"></i> Kembali
        </a>
    </div>

    <div class="main-container">
        <div class="header-text">
            <h1>Expert Coaching Hub</h1>
            <p>Pilih metode belajar interaktif yang sesuai dengan kebutuhan bisnis Anda saat ini.</p>
        </div>

        <div class="options-grid">
            
            <a href="coaching-stream.html" class="option-card style-live">
                <div class="badge-live"><i class="fas fa-circle" style="font-size:0.5rem"></i> LIVE NOW</div>
                <div class="icon-circle">
                    <i class="fas fa-broadcast-tower"></i>
                </div>
                <div>
                    <div class="card-title">Live Webinar</div>
                    <div class="card-desc">Ikuti sesi mentoring massal, webinar eksklusif, dan tanya jawab langsung dengan para ahli industri secara real-time.</div>
                </div>
            </a>

            <div class="option-card style-consult" onclick="handleConsultClick()">
                <div class="icon-circle">
                    <i class="fas fa-comments"></i>
                </div>
                <div>
                    <div class="card-title">Private Consultation</div>
                    <div class="card-desc">Konsultasi 1-on-1 secara privat melalui live chat dengan mentor pilihan. (Sistem akan mencari mentor yang available).</div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. CONFIG FIREBASE (Langsung disini agar tidak perlu file eksternal)
        const firebaseConfig = {
            apiKey: "AIzaSyBIaLzkNM0KqPVKxuMNmardLqcrr2kYTWQ",
            authDomain: "database-idbm.firebaseapp.com",
            projectId: "database-idbm",
            storageBucket: "database-idbm.firebasestorage.app",
            messagingSenderId: "1052290789133",
            appId: "1:1052290789133:web:36b513630b7a87154eca44",
            measurementId: "G-EQLBB94DY2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
            } else {
                window.location.href = "login.html";
            }
        });

        // 2. FUNGSI HANDLER (Di-expose ke window agar bisa dipanggil HTML)
        window.handleConsultClick = () => {
            if(!currentUser) {
                alert("Silakan login terlebih dahulu.");
                window.location.href = "login.html";
                return;
            }
            // Mulai pencarian mentor
            bookMentorSafe('General', currentUser.uid);
        }

        // 3. LOGIKA BOOKING MENTOR
        async function bookMentorSafe(categoryId, userId) {
            // Ubah tampilan kartu jadi loading
            const card = document.querySelector('.style-consult');
            const originalTitle = card.querySelector('.card-title').innerText;
            
            card.style.opacity = "0.7";
            card.style.pointerEvents = "none"; // Cegah klik ganda
            card.querySelector('.card-title').innerText = "Mencari Mentor...";

            try {
                // A. Cari Mentor Online
                const q = query(
                    collection(db, "users_umkm"), 
                    where("role", "==", "coach"), 
                    where("status", "==", "online")
                );
                
                const snapshot = await getDocs(q);
                
                // Filter mentor yang tidak sedang sibuk (client side filter sementara)
                const availableMentors = snapshot.docs
                    .map(doc => ({id: doc.id, ...doc.data()}))
                    .filter(m => !m.current_session); // Pastikan mentor tidak punya sesi aktif

                if (availableMentors.length === 0) {
                    throw new Error("Maaf, tidak ada mentor yang tersedia saat ini.");
                }

                // Pilih 1 Random
                const candidate = availableMentors[Math.floor(Math.random() * availableMentors.length)];

                // B. Transaksi Database (Booking)
                await runTransaction(db, async (transaction) => {
                    // Cek ulang status mentor (Double Check)
                    const mentorRef = doc(db, "users_umkm", candidate.id);
                    const mentorDoc = await transaction.get(mentorRef);

                    if (!mentorDoc.exists()) throw "Data mentor tidak ditemukan!";
                    
                    const mentorData = mentorDoc.data();
                    if (mentorData.current_session) {
                        throw "Maaf, Mentor baru saja diambil orang lain!";
                    }

                    // Buat Sesi Chat Baru
                    const newSessionRef = doc(collection(db, "chat_sessions"));
                    transaction.set(newSessionRef, {
                        user_id: userId,
                        coach_id: candidate.id,
                        category: categoryId,
                        status: "active",
                        start_time: serverTimestamp(),
                        messages: [] 
                    });

                    // Update Status Mentor jadi Sibuk
                    transaction.update(mentorRef, {
                        current_session: newSessionRef.id
                    });
                    
                    // Simpan ID sesi di window untuk redirect setelah transaksi selesai
                    window.tempSessionId = newSessionRef.id;
                });

                // C. Redirect ke Ruang Chat
                if (window.tempSessionId) {
                    window.location.href = `coaching-chat.html?session_id=${window.tempSessionId}`;
                }

            } catch (e) {
                console.error("Booking Error:", e);
                
                // Reset UI
                card.style.opacity = "1";
                card.style.pointerEvents = "auto";
                card.querySelector('.card-title').innerText = originalTitle;

                if (e === "Maaf, Mentor baru saja diambil orang lain!") {
                    // Retry otomatis jika gagal karena rebutan
                    console.log("Retrying...");
                    bookMentorSafe(categoryId, userId); 
                } else {
                    alert(e.message || "Gagal menghubungkan ke mentor.");
                }
            }
        }
    </script>

</body>
</html>