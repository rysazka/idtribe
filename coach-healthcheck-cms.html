<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Check CMS - ID-TRIBE</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

    <style>
        /* --- STYLE MATCHING COACH DASHBOARD --- */
        :root {--accent: #f59e0b; --dark: #0f172a; --bg-light: #f8fafc; --live-red: #ef4444; --primary: #059669; --sidebar-w: 280px; font-family: 'Plus Jakarta Sans', sans-serif; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg-light); color: var(--dark); display: flex; min-height: 100vh; }

        /* SIDEBAR */
        .sidebar { width: var(--sidebar-w); background: #1e293b; color: white; padding: 25px; display: flex; flex-direction: column; flex-shrink: 0; position: fixed; height: 100vh; overflow-y: auto; z-index: 100; }
        .brand { font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 800; margin-bottom: 40px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .nav-link { padding: 14px 15px; border-radius: 12px; color: #94a3b8; text-decoration: none; display: flex; align-items: center; gap: 12px; margin-bottom: 8px; transition: 0.3s; cursor: pointer; font-weight: 500; }
        .nav-link:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-link.active { background: var(--primary); font-weight: 700; box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3); color: white; }

        /* MAIN CONTENT */
        .main { flex: 1; margin-left: var(--sidebar-w); padding: 40px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-family: 'Outfit', sans-serif; font-size: 2rem; font-weight: 800; color: var(--dark); }

        /* CMS CARD STYLES */
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 20px; }
        
        /* SECTOR ACCORDION */
        .sector-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; margin-bottom: 15px; }
        .sector-header h3 { margin: 0; color: var(--primary); }
        .sector-body { display: none; animation: fadeIn 0.3s ease; }
        .sector-body.open { display: block; }

        /* QUESTION ITEM */
        .q-item { background: #f8fafc; border: 1px solid #cbd5e1; padding: 20px; border-radius: 12px; margin-bottom: 20px; position: relative; transition: 0.3s; }
        .q-item:hover { border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .q-label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 0.9rem; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit; margin-bottom: 10px; background: white; }
        .form-input:focus { border-color: var(--primary); outline: none; }

        /* OPTIONS GRID */
        .options-container { display: grid; gap: 10px; margin-top: 10px; border-top: 1px dashed #cbd5e1; padding-top: 10px; }
        .opt-row { display: grid; grid-template-columns: 40px 1fr 80px; gap: 10px; align-items: center; }
        .opt-badge { width: 30px; height: 30px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #64748b; font-size: 0.8rem; }

        /* BUTTONS */
        .btn { padding: 10px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: 700; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn-green { background: var(--primary); color: white; }
        .btn-gray { background: #64748b; color: white; }
        
        /* Tombol Aksi Item */
        .btn-del-q {
            position: absolute; top: 15px; right: 15px;
            background: #fee2e2; color: #ef4444; border: 1px solid #fecaca;
            padding: 5px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; cursor: pointer;
        }
        .btn-del-q:hover { background: #fecaca; }

        .btn-add-q {
            background: #ecfdf5; color: var(--primary); border: 1px dashed var(--primary);
            width: 100%; padding: 12px; margin-bottom: 20px;
        }
        .btn-add-q:hover { background: #d1fae5; }

        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); display: none; align-items: center; justify-content: center; z-index: 999; backdrop-filter: blur(2px); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand"><i class="fas fa-rocket"> </i> <span class="brand-text">ID-<span style="color: var(--accent);">TRIBE</span></span></div>

        <a href="coach-chat.html" class="nav-link">
            <i class="fas fa-comments"></i> Konsultasi (Chat)
        </a>
        <a href="coach-dashboard.html#stream" class="nav-link">
            <i class="fas fa-video"></i> Webinar (Stream)
        </a>
        <a href="coach-dashboard.html#booking" class="nav-link">
            <i class="fas fa-calendar-check"></i> Jadwal & Booking
        </a>
        
        <a href="coach-cms.html" class="nav-link">
            <i class="fas fa-book-open"></i> Kelola Materi (LMS)
        </a>

        <a href="#" class="nav-link active">
            <i class="fas fa-stethoscope"></i> Health Check Quiz
        </a>

        <a onclick="logout()" class="nav-link" style="margin-top: auto; color: #ef4444; cursor: pointer;">
            <i class="fas fa-sign-out-alt"></i> Keluar
        </a>
    </aside>

    <main class="main">
        <div class="header">
            <div>
                <h1 class="page-title">Editor Health Check</h1>
                <p style="color: #64748b;">Kelola pertanyaan diagnostik bisnis untuk UMKM.</p>
            </div>
            <button class="btn btn-gray" onclick="seedDefaultData()"><i class="fas fa-sync"></i> Reset Default Data</button>
        </div>

        <div id="sectorsContainer">
            <div style="text-align:center; padding:50px; color:#94a3b8;">
                <i class="fas fa-circle-notch fa-spin fa-3x"></i><br><br>Memuat Data...
            </div>
        </div>
    </main>

    <div class="loading-overlay" id="loader">
        <div style="text-align:center;">
            <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary)"></i>
            <h3 style="margin-top:15px; color:#0f172a;">Menyimpan...</h3>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBIaLzkNM0KqPVKxuMNmardLqcrr2kYTWQ",
            authDomain: "database-idbm.firebaseapp.com",
            projectId: "database-idbm",
            storageBucket: "database-idbm.firebasestorage.app",
            messagingSenderId: "1052290789133",
            appId: "1:1052290789133:web:36b513630b7a87154eca44",
            measurementId: "G-EQLBB94DY2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // AUTH CHECK
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users_umkm", user.uid));
                if (snap.exists() && (snap.data().role === 'coach' || snap.data().role === 'admin')) {
                    loadData();
                } else {
                    alert("Akses ditolak.");
                    window.location.href = "dashboard.html";
                }
            } else {
                window.location.href = "login.html";
            }
        });

        // 1. DATA DEFAULT (Untuk tombol Reset)
        const defaultSectors = [
            {
                id: 1, name: "Financial Management",
                questions: [
                    { id: "q1", text: "Bagaimana Anda memisahkan uang bisnis dan uang pribadi?", options: [{l:"A", t:"Masih campur...", v:1}, {l:"B", t:"Sudah beda...", v:3}, {l:"C", t:"Terpisah total...", v:5}] },
                    { id: "q2", text: "Alat apa yang Anda gunakan untuk mencatat keuangan?", options: [{l:"A", t:"Ingatan/kertas...", v:1}, {l:"B", t:"Spreadsheet...", v:3}, {l:"C", t:"Software Akuntansi...", v:5}] }
                ]
            },
            {
                id: 2, name: "Digital & Marketing",
                questions: [
                    { id: "q4", text: "Di mana pelanggan bisa membeli produk Anda saat ini?", options: [{l:"A", t:"Langsung/WA...", v:1}, {l:"B", t:"Marketplace/GoFood...", v:3}, {l:"C", t:"Website/App...", v:5}] }
                ]
            },
            {
                id: 3, name: "Business Logic", questions: []
            },
            {
                id: 4, name: "Productivity & Ops", questions: []
            },
            {
                id: 5, name: "Networking", questions: []
            }
        ];

        // 2. LOAD DATA DARI FIREBASE
        async function loadData() {
            const container = document.getElementById('sectorsContainer');
            container.innerHTML = "";
            
            try {
                const snapshot = await getDocs(collection(db, "health_check_quiz"));
                
                if(snapshot.empty) {
                    container.innerHTML = `<div style="text-align:center; padding:50px;">
                        <h3>Database Soal Kosong</h3>
                        <p>Klik tombol "Reset Default Data" di pojok kanan atas untuk mengisi soal awal.</p>
                    </div>`;
                    return;
                }

                const docs = [];
                snapshot.forEach(d => docs.push(d.data()));
                docs.sort((a,b) => a.id - b.id);

                docs.forEach(sector => {
                    let questionsHtml = "";
                    
                    // Render setiap pertanyaan yang sudah ada
                    if (sector.questions && sector.questions.length > 0) {
                        sector.questions.forEach((q, qIndex) => {
                            let optionsHtml = "";
                            q.options.forEach((opt) => {
                                optionsHtml += `
                                    <div class="opt-row">
                                        <div class="opt-badge">${opt.l}</div>
                                        <input type="text" class="form-input opt-text" style="margin:0" value="${opt.t}" placeholder="Teks Jawaban">
                                        <input type="number" class="form-input opt-val" style="margin:0" value="${opt.v}" placeholder="Skor">
                                    </div>
                                `;
                            });

                            questionsHtml += `
                                <div class="q-item">
                                    <button class="btn-del-q" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i> Hapus</button>
                                    <label class="q-label">Pertanyaan</label>
                                    <textarea class="form-input q-text" rows="2">${q.text}</textarea>
                                    <div class="options-container">
                                        <label class="q-label" style="font-size:0.8rem; color:#64748b;">Opsi Jawaban & Poin (1-5)</label>
                                        ${optionsHtml}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    const html = `
                        <div class="card">
                            <div class="sector-header" onclick="toggleSector('sec-${sector.id}')">
                                <h3>Sektor ${sector.id}: ${sector.name}</h3>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="sector-body" id="sec-${sector.id}">
                                <div class="form-group">
                                    <label class="q-label">Nama Sektor</label>
                                    <input type="text" class="form-input sector-name" value="${sector.name}">
                                </div>
                                
                                <div id="questions-container-${sector.id}">
                                    ${questionsHtml}
                                </div>

                                <button class="btn btn-add-q" onclick="addQuestion(${sector.id})">
                                    <i class="fas fa-plus"></i> Tambah Pertanyaan
                                </button>

                                <button class="btn btn-green" style="width:100%;" onclick="saveSector(${sector.id})">
                                    <i class="fas fa-save"></i> Simpan Perubahan Sektor Ini
                                </button>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });

            } catch (e) {
                console.error(e);
                container.innerHTML = `<div style="text-align:center; color:red;">Gagal memuat data.</div>`;
            }
        }

        // 3. FUNGSI TAMBAH PERTANYAAN (DINAMIS UI)
        window.addQuestion = (sectorId) => {
            const container = document.getElementById(`questions-container-${sectorId}`);
            const html = `
                <div class="q-item">
                    <button class="btn-del-q" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i> Hapus</button>
                    <label class="q-label">Pertanyaan Baru</label>
                    <textarea class="form-input q-text" rows="2" placeholder="Tulis pertanyaan di sini..."></textarea>
                    <div class="options-container">
                        <label class="q-label" style="font-size:0.8rem; color:#64748b;">Opsi Jawaban & Poin</label>
                        <div class="opt-row">
                            <div class="opt-badge">A</div>
                            <input type="text" class="form-input opt-text" style="margin:0" placeholder="Jawaban A">
                            <input type="number" class="form-input opt-val" style="margin:0" value="1">
                        </div>
                        <div class="opt-row">
                            <div class="opt-badge">B</div>
                            <input type="text" class="form-input opt-text" style="margin:0" placeholder="Jawaban B">
                            <input type="number" class="form-input opt-val" style="margin:0" value="3">
                        </div>
                        <div class="opt-row">
                            <div class="opt-badge">C</div>
                            <input type="text" class="form-input opt-text" style="margin:0" placeholder="Jawaban C">
                            <input type="number" class="form-input opt-val" style="margin:0" value="5">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        // 4. SIMPAN PER SEKTOR (ROBUST)
        window.saveSector = async (sectorId) => {
            document.getElementById('loader').style.display = 'flex';

            try {
                // Ambil Nama Sektor dari container sektor terkait
                const sectorBody = document.getElementById(`sec-${sectorId}`);
                const name = sectorBody.querySelector('.sector-name').value;
                
                // Ambil semua div pertanyaan di dalam sektor ini
                const questionDivs = sectorBody.querySelectorAll('.q-item');
                const questions = [];

                questionDivs.forEach((div, idx) => {
                    const text = div.querySelector('.q-text').value;
                    
                    // Ambil opsi di dalam pertanyaan ini
                    const options = [];
                    const optRows = div.querySelectorAll('.opt-row');
                    
                    optRows.forEach(row => {
                        const label = row.querySelector('.opt-badge').innerText;
                        const t = row.querySelector('.opt-text').value;
                        const v = parseInt(row.querySelector('.opt-val').value) || 0;
                        options.push({ l: label, t: t, v: v });
                    });

                    // Buat ID unik sederhana: s[sector]_q[index]
                    const qId = `s${sectorId}_q${idx + 1}`;
                    questions.push({ id: qId, text: text, options: options });
                });

                // Simpan ke Firebase
                await setDoc(doc(db, "health_check_quiz", `sector_${sectorId}`), {
                    id: sectorId,
                    name: name,
                    questions: questions
                });

                alert(`Sektor ${sectorId} berhasil disimpan! (${questions.length} Pertanyaan)`);
            } catch (e) {
                console.error(e);
                alert("Gagal menyimpan.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // 5. SEED DATA (RESET)
        window.seedDefaultData = async () => {
            if(!confirm("PERINGATAN: Ini akan menimpa semua soal yang ada dengan data default. Lanjutkan?")) return;
            
            document.getElementById('loader').style.display = 'flex';
            const batch = writeBatch(db);

            defaultSectors.forEach(sec => {
                const ref = doc(db, "health_check_quiz", `sector_${sec.id}`);
                batch.set(ref, sec);
            });

            try {
                await batch.commit();
                alert("Database berhasil di-reset ke default!");
                loadData();
            } catch(e) {
                alert("Gagal reset database.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        window.toggleSector = (id) => {
            const el = document.getElementById(id);
            el.classList.toggle('open');
        }

        window.logout = () => signOut(auth).then(() => window.location.href = "login.html");
    </script>
</body>
</html>