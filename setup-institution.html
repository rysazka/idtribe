<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Institusi - ID-TRIBE</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

    <style>
        :root {
            --primary: #0f172a; /* Warna lebih formal untuk institusi */
            --primary-light: #e2e8f0;
            --accent: #0ea5e9;
            --font-head: 'Outfit', sans-serif;
            --font-body: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            font-family: var(--font-body); background: #f8fafc; color: #1e293b;
            min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;
        }

        .setup-card {
            background: white; width: 100%; max-width: 600px;
            border-radius: 20px; padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .step-header { text-align: center; margin-bottom: 30px; }
        .step-icon { width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto 15px auto; }
        .step-title { font-family: var(--font-head); font-size: 1.5rem; font-weight: 800; margin-bottom: 5px; }
        .step-desc { color: #64748b; font-size: 0.95rem; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 0.9rem; }
        .form-input, .form-textarea {
            width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px;
            font-family: inherit; font-size: 1rem; transition: 0.3s; outline: none;
        }
        .form-input:focus { border-color: var(--accent); background: #f0f9ff; }

        /* UPLOAD AREA */
        .upload-box {
            border: 2px dashed #cbd5e1; border-radius: 16px; padding: 30px;
            text-align: center; cursor: pointer; transition: 0.3s; position: relative;
            background: #f8fafc;
        }
        .upload-box:hover { border-color: var(--accent); background: #f0f9ff; }
        .upload-icon { font-size: 2rem; color: #94a3b8; margin-bottom: 10px; }
        .preview-img { max-width: 100px; max-height: 100px; border-radius: 10px; display: none; margin: 0 auto 10px auto; object-fit: cover; }

        .btn-submit {
            width: 100%; padding: 16px; background: var(--primary); color: white;
            border: none; border-radius: 12px; font-weight: 700; font-size: 1rem;
            cursor: pointer; transition: 0.3s; margin-top: 10px;
        }
        .btn-submit:hover { background: #334155; transform: translateY(-2px); }

    </style>
</head>
<body>

    <div class="setup-card">
        <div class="step-header">
            <div class="step-icon"><i class="fas fa-building"></i></div>
            <h1 class="step-title">Profil Institusi</h1>
            <p class="step-desc">Lengkapi identitas resmi agar mudah diverifikasi.</p>
        </div>

        <form onsubmit="saveSetup(event)">
            
            <div class="form-group">
                <label class="form-label">Logo Resmi Instansi / Perusahaan</label>
                <div class="upload-box" onclick="document.getElementById('logoInput').click()">
                    <img id="logoPreview" class="preview-img">
                    <div id="uploadPlaceholder">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <div style="font-size:0.9rem; font-weight:600;">Klik untuk upload logo</div>
                        <div style="font-size:0.8rem; color:#94a3b8;">Format PNG/JPG (Max 2MB)</div>
                    </div>
                    <input type="file" id="logoInput" accept="image/*" hidden onchange="previewLogo(this)">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Alamat Kantor Pusat</label>
                <textarea id="setupAddress" class="form-textarea" rows="3" placeholder="Jl. Jendral Sudirman No..." required></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Tagline / Slogan (Opsional)</label>
                <input type="text" id="setupTagline" class="form-input" placeholder="Contoh: BUMN Hadir Untuk Negeri">
            </div>

            <div class="form-group">
                <label class="form-label">Dokumen Legalitas (Nomor SK/NIB)</label>
                <input type="text" id="setupLegal" class="form-input" placeholder="Nomor resmi untuk verifikasi..." required>
            </div>

            <button type="submit" class="btn-submit" id="btnSave">Simpan & Masuk Dashboard</button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIaLzkNM0KqPVKxuMNmardLqcrr2kYTWQ",
            authDomain: "database-idbm.firebaseapp.com",
            projectId: "database-idbm",
            storageBucket: "database-idbm.firebasestorage.app",
            messagingSenderId: "1052290789133",
            appId: "1:1052290789133:web:36b513630b7a87154eca44",
            measurementId: "G-EQLBB94DY2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;

        // CEK LOGIN
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
            } else {
                window.location.href = "login.html";
            }
        });

        // PREVIEW IMAGE
        window.previewLogo = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('logoPreview').src = e.target.result;
                    document.getElementById('logoPreview').style.display = 'block';
                    document.getElementById('uploadPlaceholder').style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // SIMPAN DATA
        window.saveSetup = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSave');
            btn.innerText = "Menyimpan...";
            btn.disabled = true;

            const address = document.getElementById('setupAddress').value;
            const tagline = document.getElementById('setupTagline').value;
            const legal = document.getElementById('setupLegal').value;
            
            // Convert Logo to Base64 (Simulasi Storage)
            let logoBase64 = null;
            const fileInput = document.getElementById('logoInput');
            if (fileInput.files.length > 0) {
                logoBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(fileInput.files[0]);
                });
            }

            try {
                // Update doc user yang sudah dibuat saat register
                const userRef = doc(db, "users_umkm", currentUser.uid);
                
                await updateDoc(userRef, {
                    alamat_lengkap: address,
                    tagline: tagline,
                    legalitas_id: legal,
                    logo_url: logoBase64, // Menyimpan gambar langsung di dokumen (tidak disarankan untuk prod, tapi oke untuk demo)
                    status_setup: "completed",
                    verified: true // Institusi biasanya auto-verified atau pending verification
                });

                Swal.fire({
                    icon: 'success',
                    title: 'Setup Selesai!',
                    text: 'Selamat datang di ekosistem ID-TRIBE.',
                    confirmButtonColor: '#0f172a'
                }).then(() => {
                    window.location.href = "dashboard.html";
                });

            } catch (error) {
                console.error("Error updating profile:", error);
                Swal.fire('Error', 'Gagal menyimpan data.', 'error');
                btn.innerText = "Simpan & Masuk Dashboard";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>