<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profil Bisnis - ID-TRIBE</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"></script>

    <style>
        /* --- 1. VARIABLES --- */
        :root {
            --primary: #059669; --primary-dark: #047857; --primary-light: #d1fae5;
            --accent: #f59e0b; --dark: #0f172a; --text-gray: #64748b; --border: #e2e8f0;
            --font-head: 'Outfit', sans-serif; --font-body: 'Plus Jakarta Sans', sans-serif;
            --shadow-sm: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-md: 0 10px 25px rgba(0,0,0,0.08);
            --shadow-glow: 0 10px 30px rgba(5, 150, 105, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-body); background: #f8fafc; color: var(--dark); padding-bottom: 60px; overflow-x: hidden; }

        /* --- 2. DECORATIVE BACKGROUND BLOBS --- */
        .bg-shapes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5; animation: float 10s infinite alternate ease-in-out; }
        .blob-1 { top: -10%; left: -10%; width: 400px; height: 400px; background: var(--primary-light); }
        .blob-2 { bottom: 10%; right: -5%; width: 350px; height: 350px; background: #fef3c7; animation-delay: -5s; }
        @keyframes float { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(20px, 40px) scale(1.1); } }

        /* --- 3. HEADER & NAVIGATION --- */
        .profile-header-bg {
            height: 240px; width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            position: relative; border-radius: 0 0 40px 40px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(5, 150, 105, 0.15);
        }
        .profile-header-bg::after {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(circle at top right, rgba(255,255,255,0.15) 0%, transparent 60%);
        }
        .nav-back {
            position: absolute; top: 25px; left: 25px; z-index: 2;
            background: rgba(255,255,255,0.15); backdrop-filter: blur(10px);
            color: white; padding: 10px 20px; border-radius: 50px;
            text-decoration: none; font-weight: 700; font-size: 0.9rem;
            display: flex; align-items: center; gap: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-back:hover { 
            background: rgba(255,255,255,0.25); 
            transform: translateX(-5px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        }

        /* --- 4. MAIN PROFILE CARD --- */
        .container { max-width: 900px; margin: -100px auto 0 auto; padding: 0 20px; position: relative; z-index: 10; }

        .profile-card {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-radius: 28px; padding: 40px 30px;
            box-shadow: var(--shadow-md); border: 1px solid rgba(255,255,255,1);
            animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            opacity: 0; transform: translateY(30px);
        }

        .profile-top { text-align: center; margin-bottom: 35px; }
        
        /* Avatar & Upload Button */
        .avatar-container { position: relative; width: 130px; height: 130px; margin: 0 auto 20px auto; }
        .avatar-lg {
            width: 100%; height: 100%; background: white; border-radius: 35px;
            display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem; font-weight: 800; color: var(--primary);
            box-shadow: var(--shadow-glow); border: 6px solid white;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background-size: cover; background-position: center; overflow: hidden;
        }
        .avatar-container:hover .avatar-lg { transform: scale(1.05) rotate(-2deg); }
        .btn-edit-avatar {
            position: absolute; bottom: -5px; right: -5px;
            background: var(--dark); color: white; border: none;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: 0.3s; z-index: 5; border: 3px solid white;
        }
        .btn-edit-avatar:hover { background: var(--primary); transform: scale(1.1); }
        
        .p-name { font-family: var(--font-head); font-size: 2.2rem; font-weight: 800; color: var(--dark); margin-bottom: 5px; letter-spacing: -0.5px; }
        .p-role { 
            font-size: 0.85rem; color: var(--primary-dark); font-weight: 700; 
            margin-bottom: 20px; display: inline-block;
            background: var(--primary-light); padding: 6px 16px; border-radius: 50px;
        }

        /* --- 5. TABS SYSTEM --- */
        .profile-tabs { 
            display: flex; gap: 12px; overflow-x: auto; margin-bottom: 30px; 
            padding-bottom: 5px; scrollbar-width: none; border-bottom: 2px solid #f1f5f9;
        }
        .profile-tabs::-webkit-scrollbar { display: none; }
        .tab-btn {
            padding: 12px 24px; background: transparent; border: none;
            border-radius: 100px; font-weight: 700; font-size: 0.9rem; cursor: pointer;
            white-space: nowrap; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: var(--text-gray);
        }
        .tab-btn:hover:not(.active) { background: #f1f5f9; color: var(--dark); }
        .tab-btn.active { background: var(--dark); color: white; box-shadow: 0 8px 20px rgba(15, 23, 42, 0.2); transform: translateY(-2px); }
        .tab-content { display: none; text-align: left; animation: fadeIn 0.4s ease forwards; opacity: 0; }
        .tab-content.active { display: block; }

        /* --- 6. DATA GRID (CARDS) --- */
        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 10px; }
        .data-item { 
            background: white; padding: 20px; border-radius: 20px; 
            border: 1px solid var(--border); position: relative; overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .data-item:hover { transform: translateY(-5px); box-shadow: var(--shadow-sm); border-color: var(--primary-light); }
        .data-item::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary); transform: scaleY(0); transition: transform 0.3s ease; transform-origin: bottom; }
        .data-item:hover::before { transform: scaleY(1); }
        .data-label { font-size: 0.8rem; color: var(--text-gray); font-weight: 700; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .data-label i { color: var(--primary); font-size: 0.9rem; background: var(--primary-light); padding: 5px; border-radius: 6px; }
        .data-value { font-size: 1.1rem; color: var(--dark); font-weight: 700; font-family: var(--font-head); word-wrap: break-word;}

        /* --- 7. COURSE & SEMINAR LIST --- */
        .list-item { 
            display: flex; align-items: center; justify-content: space-between; gap: 18px; padding: 18px; 
            background: white; border-radius: 16px; margin-bottom: 12px;
            border: 1px solid var(--border); transition: all 0.3s ease;
        }
        .list-item:hover { border-color: var(--primary); transform: translateX(5px); box-shadow: var(--shadow-sm); }
        .list-icon { 
            width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; 
            font-size: 1.2rem; flex-shrink: 0;
        }
        .icon-course { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 4px 10px rgba(5,150,105,0.3); }
        .icon-seminar { background: #e0f2fe; color: #0284c7; }
        
        .list-info { flex: 1; overflow: hidden; }
        .list-title { font-weight:700; font-size:1rem; color:var(--dark); margin-bottom:4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-meta { font-size:0.8rem; color:var(--text-gray); font-weight:600; display: flex; gap: 10px; align-items: center;}
        
        .btn-cancel-booking {
            background: #fef2f2; color: #dc2626; border: 1px solid #fecaca;
            padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 700;
            cursor: pointer; transition: 0.2s;
        }
        .btn-cancel-booking:hover { background: #fee2e2; }

        /* --- 8. BUTTONS & MODALS --- */
        .btn-edit-main { 
            width: auto; padding: 12px 25px; background: white; color: var(--dark); 
            border: 1px solid var(--border); border-radius: 100px; font-weight: 700; cursor: pointer;
            margin-top: 10px; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px;
            box-shadow: var(--shadow-sm); font-size: 0.9rem;
        }
        .btn-edit-main:hover { background: #f8fafc; border-color: #cbd5e1; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.05); }
        .btn-save { 
            width: 100%; padding: 16px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            color: white; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; 
            margin-top: 25px; font-size: 1rem; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(5, 150, 105, 0.3);
        }
        .btn-save:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(5, 150, 105, 0.4); }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(8px);
            z-index: 3000; display: none; align-items: center; justify-content: center; padding: 20px;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-card { 
            background: white; width: 100%; max-width: 650px; border-radius: 28px; padding: 35px; 
            max-height: 85vh; overflow-y: auto; position: relative;
            transform: scale(0.95) translateY(20px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .modal-overlay.active .modal-card { transform: scale(1) translateY(0); }
        .modal-header { 
            position: sticky; top: -35px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 15px 0; z-index: 10; border-bottom: 1px solid var(--border); margin-bottom: 25px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-close-modal { width: 35px; height: 35px; background: #f1f5f9; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--text-gray); cursor: pointer; transition: 0.2s; }
        .btn-close-modal:hover { background: #e2e8f0; color: var(--dark); transform: rotate(90deg); }
        .form-section-title { font-size: 0.85rem; font-weight: 800; color: var(--primary); text-transform: uppercase; margin: 25px 0 15px 0; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; }
        .form-section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        .form-group { margin-bottom: 18px; }
        .form-label { display: block; font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: var(--dark); }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 14px; font-family: inherit; font-size: 0.95rem; transition: all 0.3s ease; background: #f8fafc; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { border-color: var(--primary); outline: none; background: white; box-shadow: 0 0 0 4px var(--primary-light); }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .checkbox-label { display: flex; align-items: center; gap: 8px; background: white; padding: 10px 20px; border-radius: 50px; cursor: pointer; border: 2px solid #e2e8f0; transition: all 0.3s; color: var(--text-gray); font-weight: 500; font-size: 0.9rem; }
        .checkbox-label:hover { border-color: var(--accent); }
        .checkbox-label input { display: none; }
        .checkbox-label:has(input:checked) { background: var(--primary); border-color: var(--primary); color: white; }
        
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="bg-shapes">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <div class="profile-header-bg">
        <a href="dashboard.html" class="nav-back"><i class="fas fa-arrow-left"></i> Dashboard</a>
    </div>

    <div class="container">
        <div class="profile-card">
            
            <div class="profile-top">
                <div class="avatar-container">
                    <div class="avatar-lg" id="viewAvatar">U</div>
                    <button class="btn-edit-avatar" onclick="document.getElementById('profilePicInput').click()" title="Ubah Foto Profil">
                        <i class="fas fa-camera"></i>
                    </button>
                    <input type="file" id="profilePicInput" style="display:none" accept="image/*" onchange="uploadProfilePic(event)">
                </div>

                <h1 class="p-name" id="viewName">Memuat...</h1>
                <span class="p-role" id="viewRole">Kategori • Lokasi • Berdiri Tahun</span>
                <p id="viewDesc" style="color: var(--text-gray); font-size: 0.95rem; line-height: 1.6; max-width: 600px; margin: 0 auto 20px auto;">...</p>
                <button class="btn-edit-main" onclick="openModal()"><i class="fas fa-pen-to-square"></i> Lengkapi & Edit Profil Bisnis</button>
            </div>

            <div class="profile-tabs">
                <button class="tab-btn active" onclick="switchTab('tab-legal', this)">Legalitas</button>
                <button class="tab-btn" onclick="switchTab('tab-ops', this)">Operasional & Penjualan</button>
                <button class="tab-btn" onclick="switchTab('tab-finance', this)">Keuangan</button>
                <button class="tab-btn" onclick="switchTab('tab-history', this)">Riwayat Belajar</button>
                <button class="tab-btn" onclick="switchTab('tab-seminar', this)">Jadwal Seminar</button>
                <button class="tab-btn" onclick="switchTab('tab-security', this)">Keamanan</button>
            </div>

            <div id="tab-legal" class="tab-content active">
                <div class="data-grid">
                    <div class="data-item"><span class="data-label"><i class="fas fa-id-card"></i> NIB</span><span class="data-value" id="val_nib">-</span></div>
                    <div class="data-item"><span class="data-label"><i class="fas fa-file-pdf"></i> File Bukti NIB</span><span class="data-value" id="val_nib_file">-</span></div>
                    <div class="data-item"><span class="data-label"><i class="fas fa-file-invoice-dollar"></i> NPWP</span><span class="data-value" id="val_npwp">-</span></div>
                    <div class="data-item"><span class="data-label"><i class="fas fa-certificate"></i> Sertifikasi Halal</span><span class="data-value" id="val_halal">-</span></div>
                    <div class="data-item"><span class="data-label"><i class="fas fa-stamp"></i> Izin Edar (BPOM/PIRT)</span><span class="data-value" id="val_izin">-</span></div>
                </div>
            </div>

            <div id="tab-ops" class="tab-content">
                <div class="data-grid">
                    <div class="data-item"><span class="data-label"><i class="fas fa-users"></i> Jumlah Tim</span><span class="data-value" id="val_staff">-</span></div>
                    <div class="data-item"><span class="data-label"><i class="fas fa-box-open"></i> Kapasitas Produksi</span><span class="data-value" id="val_kapasitas">-</span></div>
                    <div class="data-item"><span class="data-label"><i class="fas fa-network-wired"></i> Model Bisnis</span><span class="data-value" id="val_model">-</span></div>
                    <div class="data-item"><span class="data-label"><i class="fas fa-store"></i> Channel Penjualan</span><span class="data-value" id="val_channels">-</span></div>
                    <div class="data-item"><span class="data-label"><i class="fas fa-hashtag"></i> Sosial Media / Web</span><span class="data-value" id="val_sosmed">-</span></div>
                    <div class="data-item"><span class="data-label"><i class="fas fa-warehouse"></i> Manajemen Stok</span><span class="data-value" id="val_stok">-</span></div>
                </div>
            </div>

            <div id="tab-finance" class="tab-content">
                <div class="data-grid">
                    <div class="data-item"><span class="data-label"><i class="fas fa-chart-line"></i> Omzet Bulanan</span><span class="data-value" id="val_omzet">-</span></div>
                    <div class="data-item"><span class="data-label"><i class="fas fa-tags"></i> HPP Rata-rata</span><span class="data-value" id="val_hpp">-</span></div>
                    <div class="data-item"><span class="data-label"><i class="fas fa-percentage"></i> Profit Margin</span><span class="data-value" id="val_margin">-</span></div>
                    <div class="data-item"><span class="data-label"><i class="fas fa-book"></i> Pencatatan</span><span class="data-value" id="val_catatan">-</span></div>
                </div>
            </div>

            <div id="tab-history" class="tab-content">
                <div id="moduleList">
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-folder-open" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 15px;"></i>
                        <p style="color: var(--text-gray); font-weight: 500;">Belum ada modul yang diselesaikan.</p>
                    </div>
                </div>
            </div>

            <div id="tab-seminar" class="tab-content">
                <div id="bookedSeminarList">
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="far fa-calendar-times" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 15px;"></i>
                        <p style="color: var(--text-gray); font-weight: 500;">Anda belum mendaftar seminar apa pun.</p>
                    </div>
                </div>
            </div>

            <div id="tab-security" class="tab-content">
                <div class="data-item" style="text-align: center; padding: 40px 20px; border-style: dashed; background: transparent;">
                    <i class="fas fa-shield-alt" style="font-size: 3.5rem; color: var(--primary); margin-bottom: 20px; filter: drop-shadow(0 4px 10px rgba(5,150,105,0.3));"></i>
                    <h3 style="margin-bottom: 10px; font-family: var(--font-head); font-weight: 800; font-size: 1.5rem;">Keamanan Akun</h3>
                    <p style="color: var(--text-gray); font-size: 0.95rem; margin-bottom: 25px; max-width: 400px; margin-left: auto; margin-right: auto;">
                        Demi keamanan data bisnis Anda, disarankan untuk memperbarui kata sandi secara berkala.
                    </p>
                    <button class="btn-save" onclick="openPasswordModal()" style="max-width: 250px; margin: 0 auto; background: var(--dark); box-shadow: 0 8px 20px rgba(15, 23, 42, 0.3);">
                        <i class="fas fa-key" style="margin-right: 8px;"></i> Ubah Kata Sandi
                    </button>
                </div>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-card">
            <div class="modal-header">
                <h2 style="font-family: var(--font-head); font-weight: 800;">Update Data Bisnis</h2>
                <button class="btn-close-modal" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <form id="profileForm" onsubmit="handleSave(event)">
                <div class="form-section-title"><i class="fas fa-info-circle"></i> Profil Dasar</div>
                <div class="form-group">
                    <label class="form-label">Nama Brand / Usaha</label>
                    <input type="text" id="in_nama_usaha" class="form-input" required placeholder="Cth: Tahu Gejrot Cirebon">
                </div>
                <div class="form-group">
                    <label class="form-label">Kategori / Sektor</label>
                    <select id="in_kategori" class="form-select" required>
                        <option value="kuliner">Kuliner</option>
                        <option value="fashion">Fashion</option>
                        <option value="craft">Kerajinan</option>
                        <option value="jasa">Jasa</option>
                        <option value="agri">Agribisnis</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Deskripsi Usaha</label>
                    <textarea id="in_deskripsi" class="form-textarea" rows="3" placeholder="Ceritakan singkat tentang produk dan bisnis Anda..."></textarea>
                </div>
                <div class="data-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label class="form-label">Tahun Berdiri</label>
                        <input type="number" id="in_tahun" class="form-input" placeholder="Cth: 2020">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kota/Lokasi</label>
                        <input type="text" id="in_lokasi" class="form-input" placeholder="Cth: Bandung">
                    </div>
                </div>

                <div class="form-section-title"><i class="fas fa-balance-scale"></i> Legalitas & Kepatuhan</div>
                <div class="data-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label class="form-label">Nomor NIB</label>
                        <input type="text" id="in_nib" class="form-input" placeholder="13 Digit NIB">
                    </div>
                    <div class="form-group">
                        <label class="form-label">NPWP Usaha</label>
                        <input type="text" id="in_npwp" class="form-input" placeholder="15/16 Digit NPWP">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Upload Bukti NIB Baru (PDF/Gambar)</label>
                    <input type="file" id="in_nib_file" class="form-input" accept=".pdf,image/*">
                    <small style="color:var(--text-gray); font-size:0.8rem;">Kosongkan jika tidak ingin mengubah file saat ini.</small>
                </div>
                <div class="data-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label class="form-label">Status Halal</label>
                        <select id="in_halal" class="form-select">
                            <option value="belum">Belum Ada</option>
                            <option value="proses">Sedang Proses</option>
                            <option value="ada">Sudah Ada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Izin Edar (BPOM/PIRT)</label>
                        <input type="text" id="in_izin" class="form-input" placeholder="Nomor PIRT/BPOM">
                    </div>
                </div>

                <div class="form-section-title"><i class="fas fa-cogs"></i> Data Operasional & Penjualan</div>
                <div class="data-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label class="form-label">Jumlah Karyawan</label>
                        <select id="in_karyawan" class="form-select">
                            <option value="sendiri">Dikelola Sendiri (Solo)</option>
                            <option value="keluarga">Dibantu Keluarga/Teman</option>
                            <option value="kecil">Tim Kecil (1-5 Orang)</option>
                            <option value="profesional">Tim Profesional (>5 Orang)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Model Bisnis</label>
                        <select id="in_model" class="form-select">
                            <option value="b2c">B2C (Langsung ke Konsumen)</option>
                            <option value="b2b">B2B (Ke Bisnis Lain/Kantor)</option>
                            <option value="reseller">Reseller / Dropship</option>
                            <option value="hybrid">Campuran (B2B & B2C)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Kapasitas Produksi (Per Bulan)</label>
                    <input type="text" id="in_kapasitas" class="form-input" placeholder="Cth: 1000 pcs / 500 porsi">
                </div>
                <div class="form-group">
                    <label class="form-label">Sosial Media Utama / Website</label>
                    <input type="text" id="in_sosmed" class="form-input" placeholder="Cth: @keripikjuara">
                </div>
                <div class="form-group">
                    <label class="form-label">Kanal Penjualan (Pilih yang aktif)</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label"><input type="checkbox" value="Shopee" name="in_kanal"> <span>Shopee</span></label>
                        <label class="checkbox-label"><input type="checkbox" value="Tokopedia" name="in_kanal"> <span>Tokopedia</span></label>
                        <label class="checkbox-label"><input type="checkbox" value="Tiktok" name="in_kanal"> <span>TikTok Shop</span></label>
                        <label class="checkbox-label"><input type="checkbox" value="Instagram" name="in_kanal"> <span>Instagram</span></label>
                        <label class="checkbox-label"><input type="checkbox" value="Offline" name="in_kanal"> <span>Toko Fisik</span></label>
                        <label class="checkbox-label"><input type="checkbox" value="WhatsApp" name="in_kanal"> <span>WhatsApp</span></label>
                    </div>
                </div>

                <div class="form-section-title"><i class="fas fa-wallet"></i> Data Keuangan (Per Bulan)</div>
                <div class="form-group">
                    <label class="form-label">Range Omzet Bulanan</label>
                    <select id="in_omzet" class="form-select" required>
                        <option value="mikro_bawah">&lt; 5 Juta</option>
                        <option value="mikro_atas">5 - 10 Juta</option>
                        <option value="kecil_bawah">10 - 50 Juta</option>
                        <option value="kecil_atas">50 - 300 Juta</option>
                        <option value="menengah">&gt; 300 Juta</option>
                    </select>
                </div>
                <div class="data-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label class="form-label">HPP per Produk Rata-rata</label>
                        <input type="text" id="in_hpp" class="form-input" placeholder="Cth: Rp 15.000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Profit Margin Rata-rata (%)</label>
                        <input type="text" id="in_margin" class="form-input" placeholder="Cth: 30%">
                    </div>
                </div>

                <button type="submit" class="btn-save" id="saveBtn"><i class="fas fa-save" style="margin-right: 5px;"></i> Simpan Semua Perubahan</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="passwordModal">
        <div class="modal-card" style="max-width: 450px;">
            <div class="modal-header">
                <h2 style="font-family: var(--font-head); font-weight: 800;">Ubah Password</h2>
                <button class="btn-close-modal" onclick="closePasswordModal()"><i class="fas fa-times"></i></button>
            </div>
            <form id="passwordForm" onsubmit="handleUpdatePassword(event)">
                <div class="form-group">
                    <label class="form-label">Password Saat Ini</label>
                    <input type="password" id="old_password" class="form-input" required placeholder="Masukkan password lama">
                </div>
                <div style="height: 1px; background: var(--border); margin: 25px 0; position: relative;">
                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 0 15px; color: var(--text-gray); font-size: 0.8rem; font-weight: 600; text-transform: uppercase;">Password Baru</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Password Baru</label>
                    <input type="password" id="new_password" class="form-input" required placeholder="Minimal 6 karakter">
                </div>
                <div class="form-group">
                    <label class="form-label">Konfirmasi Password Baru</label>
                    <input type="password" id="confirm_password" class="form-input" required placeholder="Ulangi password baru">
                </div>
                <button type="submit" class="btn-save" id="passBtn" style="background: var(--dark); box-shadow: 0 8px 20px rgba(15, 23, 42, 0.3);"><i class="fas fa-check-circle" style="margin-right: 5px;"></i> Perbarui Password</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIaLzkNM0KqPVKxuMNmardLqcrr2kYTWQ",
            authDomain: "database-idbm.firebaseapp.com",
            projectId: "database-idbm",
            storageBucket: "database-idbm.firebasestorage.app",
            messagingSenderId: "1052290789133",
            appId: "1:1052290789133:web:36b513630b7a87154eca44",
            measurementId: "G-EQLBB94DY2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let uid = null;
        let currentData = {}; 

        const omzetMap = { "mikro_bawah": "< 5 Juta", "mikro_atas": "5 - 10 Juta", "kecil_bawah": "10 - 50 Juta", "kecil_atas": "50 - 300 Juta", "menengah": "> 300 Juta" };
        const karyawanMap = { "sendiri": "Dikelola Sendiri (Solo)", "keluarga": "Dibantu Keluarga/Teman", "kecil": "Tim Kecil (1-5 Orang)", "profesional": "Tim Profesional (>5 Orang)" };
        const modelMap = { "b2c": "B2C (Ke Konsumen)", "b2b": "B2B (Ke Bisnis)", "reseller": "Reseller/Dropship", "hybrid": "Campuran" };
        const halalMap = { "belum": "Belum Ada", "proses": "Sedang Proses", "ada": "Sudah Ada" };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                uid = user.uid;
                fetchData();
                loadBookedSeminars(); // Load jadwal seminar saat login
            } else {
                window.location.href = 'login.html';
            }
        });

        async function fetchData() {
            const docRef = doc(db, "users_umkm", uid);
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                currentData = snap.data();
                renderUI(currentData);
                loadModules(currentData.completed_courses || []);
            }
        }

        function renderUI(data) {
            const namaUsaha = data.brand || "Nama Usaha";
            document.getElementById('viewName').innerText = namaUsaha;
            
            // Render Foto Profil / Inisial
            const avatarDiv = document.getElementById('viewAvatar');
            if (data.profilePicUrl) {
                avatarDiv.style.backgroundImage = `url('${data.profilePicUrl}')`;
                avatarDiv.innerText = ''; // Hilangkan huruf inisial
            } else {
                avatarDiv.style.backgroundImage = 'none';
                avatarDiv.innerText = namaUsaha.charAt(0).toUpperCase();
            }
            
            let catLabel = data.kategori ? (data.kategori.charAt(0).toUpperCase() + data.kategori.slice(1)) : 'Sektor';
            document.getElementById('viewRole').innerText = `${catLabel} • ${data.lokasi || 'Lokasi'} • Sejak ${data.tahun_berdiri || '-'}`;
            document.getElementById('viewDesc').innerText = data.deskripsi || "Belum ada deskripsi usaha. Lengkapi profil Anda agar lebih profesional.";

            // TABS DATA BINDING...
            document.getElementById('val_nib').innerText = data.nib || "-";
            document.getElementById('val_npwp').innerText = data.npwp || "-";
            document.getElementById('val_halal').innerText = halalMap[data.status_halal] || data.status_halal || "-";
            document.getElementById('val_izin').innerText = data.izin_edar || "-";
            
            if(data.nib_file_url) {
                document.getElementById('val_nib_file').innerHTML = `<a href="${data.nib_file_url}" target="_blank" style="color: var(--primary); font-size: 0.95rem; font-weight: 700; text-decoration: none;"><i class="fas fa-external-link-alt"></i> Lihat Dokumen</a>`;
            } else { document.getElementById('val_nib_file').innerText = "Belum diunggah"; }

            document.getElementById('val_omzet').innerText = omzetMap[data.range_omzet] || data.range_omzet || "-";
            document.getElementById('val_hpp').innerText = data.hpp || "-";
            document.getElementById('val_margin').innerText = data.profit_margin || "-";
            document.getElementById('val_catatan').innerText = data.financial_record_status || "Belum Rutin";

            document.getElementById('val_staff').innerText = karyawanMap[data.jumlah_karyawan] || data.jumlah_karyawan || "-";
            document.getElementById('val_kapasitas').innerText = data.kapasitas_produksi || "-";
            document.getElementById('val_model').innerText = modelMap[data.model_bisnis] || (data.model_bisnis || "-").toUpperCase();
            document.getElementById('val_channels').innerText = Array.isArray(data.kanal_penjualan) ? data.kanal_penjualan.join(', ') : (data.kanal_penjualan || "-");
            document.getElementById('val_sosmed').innerText = data.sosmed || "-";
            document.getElementById('val_stok').innerText = data.inventory_status || "Manual";

            // PRE-FILL FORM
            document.getElementById('in_nama_usaha').value = data.brand || "";
            document.getElementById('in_deskripsi').value = data.deskripsi || "";
            document.getElementById('in_kategori').value = data.kategori || "kuliner";
            document.getElementById('in_tahun').value = data.tahun_berdiri || "";
            document.getElementById('in_lokasi').value = data.lokasi || "";
            
            document.getElementById('in_nib').value = data.nib || "";
            document.getElementById('in_npwp').value = data.npwp || "";
            document.getElementById('in_halal').value = data.status_halal || "belum";
            document.getElementById('in_izin').value = data.izin_edar || "";
            
            document.getElementById('in_karyawan').value = data.jumlah_karyawan || "sendiri";
            document.getElementById('in_model').value = data.model_bisnis || "b2c";
            document.getElementById('in_kapasitas').value = data.kapasitas_produksi || "";
            document.getElementById('in_sosmed').value = data.sosmed || "";
            document.getElementById('in_omzet').value = data.range_omzet || "mikro_bawah";
            document.getElementById('in_hpp').value = data.hpp || "";
            document.getElementById('in_margin').value = data.profit_margin || "";

            const userKanals = data.kanal_penjualan || [];
            document.querySelectorAll('input[name="in_kanal"]').forEach(cb => cb.checked = userKanals.includes(cb.value));
        }

        // --- FUNGSI UPLOAD FOTO PROFIL ---
        window.uploadProfilePic = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 2 * 1024 * 1024) {
                Swal.fire('Gagal', 'Ukuran foto maksimal 2MB', 'error');
                return;
            }

            Swal.fire({ title: 'Mengunggah Foto...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                const storageRef = ref(storage, `profile_pics/${uid}_${Date.now()}`);
                await uploadBytes(storageRef, file);
                const url = await getDownloadURL(storageRef);

                await updateDoc(doc(db, "users_umkm", uid), { profilePicUrl: url });

                Swal.fire('Berhasil!', 'Foto profil diperbarui.', 'success');
                fetchData(); // Reload UI
            } catch (error) {
                console.error(error);
                Swal.fire('Gagal', 'Gagal mengunggah foto profil.', 'error');
            }
        };

        // --- MENGAMBIL DATA JADWAL SEMINAR ---
        async function loadBookedSeminars() {
            const container = document.getElementById('bookedSeminarList');
            try {
                const q = query(collection(db, "bookings"), where("user_uid", "==", uid));
                const snap = await getDocs(q);
                
                container.innerHTML = "";

                if (snap.empty) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <i class="far fa-calendar-times" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 15px;"></i>
                            <p style="color: var(--text-gray); font-weight: 500;">Anda belum mendaftar seminar apa pun.</p>
                        </div>`;
                    return;
                }

                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    
                    container.innerHTML += `
                    <div class="list-item" id="book-${docSnap.id}">
                        <div class="list-icon icon-seminar"><i class="fas fa-video"></i></div>
                        <div class="list-info">
                            <div class="list-title">${data.seminar_title || "Seminar"}</div>
                            <div class="list-meta">
                                <span><i class="far fa-calendar-alt"></i> ${data.schedule_date || "-"}</span>
                                <span><i class="fas fa-user-tie"></i> ${data.coach_name || "ID-TRIBE"}</span>
                            </div>
                        </div>
                        <button class="btn-cancel-booking" onclick="cancelBooking('${docSnap.id}')">Batalkan</button>
                    </div>`;
                });
            } catch (e) {
                console.error(e);
                container.innerHTML = '<p style="color:red; text-align:center;">Gagal memuat jadwal seminar.</p>';
            }
        }

        // --- FUNGSI CANCEL BOOKING ---
        window.cancelBooking = async (bookingId) => {
            const confirm = await Swal.fire({
                title: 'Batalkan Pendaftaran?',
                text: "Jadwal ini akan dihapus dari daftar Anda.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#cbd5e1',
                confirmButtonText: 'Ya, Batalkan'
            });

            if (confirm.isConfirmed) {
                try {
                    await deleteDoc(doc(db, "bookings", bookingId));
                    Swal.fire('Dibatalkan!', 'Jadwal seminar berhasil dihapus.', 'success');
                    // Hapus elemen dari UI langsung agar tidak perlu load ulang semua
                    document.getElementById(`book-${bookingId}`).remove();
                    
                    // Cek jika daftar kosong
                    const list = document.getElementById('bookedSeminarList');
                    if (list.children.length === 0) {
                        loadBookedSeminars(); // Render ulang tampilan kosong
                    }
                } catch (error) {
                    Swal.fire('Gagal', 'Terjadi kesalahan saat membatalkan.', 'error');
                }
            }
        };

        async function loadModules(completedIds) {
            const listContainer = document.getElementById('moduleList');
            if (completedIds.length === 0) return; 

            listContainer.innerHTML = ""; 
            const coursesSnap = await getDocs(collection(db, "courses"));
            
            coursesSnap.forEach(doc => {
                if (completedIds.includes(doc.id)) {
                    const c = doc.data();
                    listContainer.innerHTML += `
                        <div class="list-item">
                            <div class="list-icon icon-course"><i class="fas fa-check"></i></div>
                            <div class="list-info">
                                <div class="list-title">${c.title}</div>
                                <div class="list-meta">Level: ${c.level || 'Beginner'}</div>
                            </div>
                        </div>`;
                }
            });
        }

        window.handleSave = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Menyimpan...`;

            try {
                let nibUrl = currentData.nib_file_url || ""; 
                const nibFileInput = document.getElementById('in_nib_file').files[0];
                
                if(nibFileInput) {
                    if (nibFileInput.size > 2 * 1024 * 1024) throw new Error("Ukuran file NIB maksimal 2MB");
                    const storageRef = ref(storage, `nib_files/${uid}_${nibFileInput.name}`);
                    await uploadBytes(storageRef, nibFileInput);
                    nibUrl = await getDownloadURL(storageRef);
                }

                let kanalArray = [];
                document.querySelectorAll('input[name="in_kanal"]:checked').forEach(cb => kanalArray.push(cb.value));

                const updates = {
                    brand: document.getElementById('in_nama_usaha').value,
                    kategori: document.getElementById('in_kategori').value,
                    deskripsi: document.getElementById('in_deskripsi').value,
                    tahun_berdiri: document.getElementById('in_tahun').value,
                    lokasi: document.getElementById('in_lokasi').value,
                    nib: document.getElementById('in_nib').value,
                    nib_file_url: nibUrl,
                    npwp: document.getElementById('in_npwp').value,
                    status_halal: document.getElementById('in_halal').value,
                    izin_edar: document.getElementById('in_izin').value,
                    jumlah_karyawan: document.getElementById('in_karyawan').value,
                    model_bisnis: document.getElementById('in_model').value,
                    kapasitas_produksi: document.getElementById('in_kapasitas').value,
                    sosmed: document.getElementById('in_sosmed').value,
                    kanal_penjualan: kanalArray,
                    range_omzet: document.getElementById('in_omzet').value,
                    hpp: document.getElementById('in_hpp').value,
                    profit_margin: document.getElementById('in_margin').value,
                    last_updated: new Date()
                };

                await updateDoc(doc(db, "users_umkm", uid), updates);
                
                Swal.fire({ icon: 'success', title: 'Berhasil!', text: 'Data profil diperbarui.', timer: 1500, showConfirmButton: false });
                
                fetchData(); 
                closeModal();
            } catch (err) {
                Swal.fire('Error', err.message || 'Gagal menyimpan data.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-save"></i> Simpan Semua Perubahan`;
            }
        };

        window.openPasswordModal = () => document.getElementById('passwordModal').classList.add('active');
        window.closePasswordModal = () => {
            document.getElementById('passwordModal').classList.remove('active');
            document.getElementById('passwordForm').reset();
        };

        window.handleUpdatePassword = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('passBtn');
            const oldPass = document.getElementById('old_password').value;
            const newPass = document.getElementById('new_password').value;
            const confirmPass = document.getElementById('confirm_password').value;

            if (newPass.length < 6) return Swal.fire('Gagal', 'Password baru minimal 6 karakter.', 'warning');
            if (newPass !== confirmPass) return Swal.fire('Gagal', 'Konfirmasi password tidak cocok.', 'warning');

            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Memproses...`;

            try {
                const user = auth.currentUser;
                const credential = EmailAuthProvider.credential(user.email, oldPass);
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, newPass);

                Swal.fire({ icon: 'success', title: 'Berhasil!', text: 'Password Anda telah diperbarui.', timer: 2000, showConfirmButton: false });
                closePasswordModal();
            } catch (error) {
                let msg = "Terjadi kesalahan.";
                if (error.code === 'auth/wrong-password') msg = "Password lama Anda salah.";
                Swal.fire('Error', msg, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-check-circle"></i> Perbarui Password`;
            }
        };

        window.switchTab = (tabId, btn) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        };

        window.openModal = () => document.getElementById('editModal').classList.add('active');
        window.closeModal = () => {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('in_nib_file').value = ""; 
        }
    </script>
</body>
</html>